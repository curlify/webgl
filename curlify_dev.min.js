function createMultilineText(t,e,i,n){e=e.replace("\n"," ");var r,a,o,s=e,l=0,u=0,c=e.split(" ");for(a=o=c.length;t.measureText(s).width>i&&a>1;){a--;s=r="";for(var h=0;o>h;h++)a>h?(s+=c[h],a>h+1&&(s+=" ")):(r+=c[h],o>h+1&&(r+=" "))}return n.push(s),u=t.measureText(s),r&&(l=createMultilineText(t,r,i,n),l>u&&(u=l)),u}var animator=function(){var t={time:!0,ease:!0,start:!0,onComplete:!0};return{animations:[],animate:function(e,i){null==i.ease&&(i.ease=animator.linear),null==i.start&&(i.start=0);var n={};for(var r in i){{i[r]}null==t[r]&&(curlify.assert(null!=e[r],"Animated property cannot be initially nil : "+r),n[r]=e[r])}this.animations.push({target:e,start:sys.timestamp()+i.start,deadline:sys.timestamp()+i.start+i.time,config:i,init:n})},step:function(){var t=[],e=sys.timestamp();for(var n in this.animations){var r=this.animations[n],a=(r.deadline,0);1==r.paused&&(e=r.pausetimestamp),e<r.deadline?a=1-(r.deadline-e)/r.config.time:e<r.start?a=0:(a=1,t.push(n)),a=Math.max(a,1e-5);for(var n in r.init)initial=r.init[n],r.target[n]=r.config.ease(initial,r.config[n],a)}for(i=t.length-1;i>=0;i--){var o=this.animations[t[i]].config.onComplete;this.animations.splice(t[i],1),null!=o&&o()}},pause:function(){for(var t in this.animations)this.animations[t].paused=!0,this.animations[t].pausetimestamp=sys.timestamp()},resume:function(){for(var t in this.animations)this.animations[t].paused=!1,this.animations[t].deadline=this.animations[t].deadline+(sys.timestamp()-self.animations[t].pausetimestamp)},stop:function(){for(var t in this.animations)this.animations[t].init={},this.animations[t].config.onComplete=null;this.animations=[]}}};animator.linear=function(t,e,i){return t+(e-t)*i},animator.inQuad=function(t,e,i){return t+(e-t)*i*i},animator.outQuad=function(t,e,i){return t+-(e-t)*i*(i-2)},animator.inOutQuad=function(t,e,i){return.5>i?(i=2*i,t+(e-t)/2*i*i):(i=2*(i-.5),t-(e-t)/2*(i*(i-2)-1))},animator.inCubic=function(t,e,i){return t+(e-t)*i*i*i},animator.outCubic=function(t,e,i){return i-=1,t+(e-t)*(i*i*i+1)},animator.inOutCubic=function(t,e,i){return.5>i?(i=2*i,t+(e-t)/2*i*i*i):(i=2*(i-.5)-1,t+(e-t)/2*(i*i*i+2))},animator.inQuart=function(t,e,i){return t+(e-t)*i*i*i*i},animator.outQuart=function(t,e,i){return i-=1,t-(e-t)*(i*i*i*i-1)},animator.inOutQuart=function(t,e,i){return.5>i?(i=2*i,t+(e-t)/2*i*i*i*i):(i=2*(i-.5)-1,t-(e-t)/2*(i*i*i*i-2))},animator.inSine=function(t,e,i){return t+(e-t)*(1-Math.cos(i*Math.pi/2))},animator.outSine=function(t,e,i){return t+(e-t)*Math.sin(i*Math.pi/2)},animator.inOutSine=function(t,e,i){return t-(e-t)/2*(Math.cos(Math.pi*i)-1)},animator.inExpo=function(t,e,i){return i-=1,t+(e-t)*Math.pow(2,10*i)},animator.outExpo=function(t,e,i){return t+(e-t)*(1-Math.pow(2,-10*i))},animator.inOutExpo=function(t,e,i){return.5>i?(i=2*i-1,t+(e-t)/2*Math.pow(2,10*i)):(i=2*(i-.5),t+(e-t)/2*(2-Math.pow(2,-10*i)))},animator.inCirc=function(t,e,i){return t+(e-t)*(1-Math.sqrt(1-i*i))},animator.outCirc=function(t,e,i){return i-=1,t+(e-t)*Math.sqrt(1-i*i)},animator.inOutCirc=function(t,e,i){return.5>i?(i=2*i,t+(e-t)/2*(1-Math.sqrt(1-i*i))):(i=2*(i-.5)-1,t+(e-t)/2*(1+Math.sqrt(1-i*i)))},animator.inElastic=function(t,e,i){return i-=1,t-(e-t)*Math.pow(2,10*i)*Math.sin(6*(i-.0777777)*Math.pi)},animator.outElastic=function(t,e,i){return t+(e-t)*(Math.pow(2,-10*i)*Math.sin(6*(i-.0777777)*Math.pi)+1)},animator["new"]=function(){return new animator};var button=function(t){var e=image["new"](t);return e.focused=!1,e.identifier="button : "+t,e.hit=function(t,e){return t<-this.width()/2||t>this.width()/2||e<-this.height()/2||e>this.height()/2?!1:!0},e.relativePress=function(t,e){return this.hit(t,e)?(null!=this.focus&&this.focus(t,e),this.focused=!0,!0):!1},e.relativeDrag=function(t,e){return 1!=this.focused?!1:(1!=this.hit(t,e)?(null!=this.defocus&&this.defocus(t,e),this.focused=!1):null!=this.focusdrag&&this.focusdrag(t,e),!0)},e.relativeRelease=function(t,e){return 1!=this.focused?!1:(null!=this.click&&this.click(t,e),null!=this.defocus&&this.defocus(t,e),this.focused=!1,!0)},e.pointerReset=function(){null!=this.defocus&&this.defocus(0,0),this.focused=!1},e};button["new"]=function(t){return new button(t)};var carousel=function(t,e,i){var n=new focusable(t,e,i),r={name:"coverflow",show:[],hide:[]};r.show.push({target:"position.x",startposition:1*screenWidth,endposition:0,func:animator.linear}),r.show.push({target:"rotate.y",startposition:.8*Math.PI,endposition:0,func:animator.linear}),r.show.push({target:"scale.x",startposition:.6,endposition:1,func:animator.linear}),r.show.push({target:"scale.y",startposition:.6,endposition:1,func:animator.linear}),r.hide.push({target:"position.x",startposition:0,endposition:1*-screenWidth,func:animator.linear}),r.hide.push({target:"rotate.y",startposition:0,endposition:.8*-Math.PI,func:animator.linear}),r.hide.push({target:"scale.x",startposition:1,endposition:.6,func:animator.linear}),r.hide.push({target:"scale.y",startposition:1,endposition:.6,func:animator.linear}),n.contentsize={width:n.size.width,height:n.size.height},n.inertia=5,n.swipespeed=screenWidth,n.movespeed=1,n.movethreshold=60,n.itemsize=screenWidth,n.transition=r,n.unload_distance=1,n.wrap=!1,n.bounceOnWrap=!1,n.alwaysmove=!1,n.nevermove=!1,n.selecteditem=1,n.moveToSelectedItem=!0;var a=n.add(new object("carousel"));a.targetposition={x:0,y:0,z:0},a.pressOffset={x:0,y:0};var o=n.add(new object("item container"));o.targetposition={x:0,y:0,z:0},n.instance=a,n.itemcontainer=o;var s=function(t,e,i){i>100&&(i=100);var r=1;t>e&&(r=-1);var a=-r*i/(16.66*n.inertia)*Math.abs(t-e);return Math.abs(a)<1e-4?t=e:t-=a,1==r&&t>e&&(t=e),-1==r&&e>t&&(t=e),t};return a.setMoving=function(t,e){null==scene.getpointerStealer()&&1!=n.nevermove&&(scene.stealPointers(n),null!=n.stolePointers&&n.stolePointers(t,e),a.moving=!0)},n.focus=function(t,e){a.moving&&(a.moving=!1,a.targetposition.x=a.position.x,a.targetposition.y=a.position.y),a.pressOffset={x:a.targetposition.x-t*n.movespeed/screenWidth*2,y:a.targetposition.y-e*n.movespeed},n.pressStarted={x:t,y:e}},n.focusdrag=function(t,e){var i=a.pressOffset.x+t*n.movespeed/screenWidth*2,r=a.pressOffset.y+e*n.movespeed/screenHeight*2,o=n.pressStarted.x-t,s=n.pressStarted.y-e;(n.alwaysmove||n.contentsize.width!=n.size.width)&&Math.abs(o)>n.movethreshold&&a.setMoving(o,s),a.moving&&(a.targetposition.x=i,a.targetposition.y=r)},n.defocus=function(){var t=Math.floor(-a.targetposition.x+.5);n.moveToSelectedItem&&(a.targetposition.x=-t),n.selecteditem=t,n.selecteditem<0&&(n.selecteditem=n.wrap?o.children.length+t:0),n.selecteditem>o.children.length-1&&(n.selecteditem=n.wrap?t-o.children.length:o.children.length-1),n.selecteditem=n.selecteditem+1,null!=n.carouselmoved&&n.carouselmoved(n.selecteditem)},n.postDraw=function(){if(n.wrap)for(var t=0;t<o.children.length;t++){var e=o.children[t],i=e.active,r=e.visible,a=e.itemposition;e.itemposition=a+o.children.length,e.stepTree(),e.drawTree(),e.itemposition=a-o.children.length,e.stepTree(),e.drawTree(),e.itemposition=a,e.step(0),e.visible=r,e.active=i}},n.selected=function(){return n.selecteditem},n.getItem=function(t){return o.children[t-1]},n.moveto=function(t,e){a.targetposition.x=-t,e&&(a.position.x=a.targetposition.x),n.selecteditem=t,null!=n.carouselmoved&&n.carouselmoved(t+1)},n.step=function(t){var e=-o.children.length+1,i=-o.children.length+1,r=.75,l=.75;0==n.wrap||n.bounceOnWrap&&a.position.x>e-r&&a.position.x<r?(n.bounceOnWrap&&(r=2*r,l=2*l),a.targetposition.x>r&&(a.targetposition.x=r),a.targetposition.y>l&&(a.targetposition.y=l),a.targetposition.x<e-r&&(a.targetposition.x=e-r),a.targetposition.y<i-l&&(a.targetposition.y=i-l),0==n.focused&&(a.targetposition.x>0&&(a.targetposition.x=s(a.targetposition.x,0,t/2)),a.targetposition.y>0&&(a.targetposition.y=s(a.targetposition.y,0,t/2)),a.targetposition.x<e&&(a.targetposition.x=s(a.targetposition.x,e,t/2)),a.targetposition.y<i&&(a.targetposition.y=s(a.targetposition.y,i,t/2)))):a.targetposition.x>1?(console.log("switch",a.position.x,a.targetposition.x,n.contentsize.width),a.targetposition.x=a.targetposition.x-o.children.length,a.position.x=a.position.x-o.children.length,a.pressOffset.x=a.pressOffset.x-o.children.length):a.targetposition.x<-o.children.length&&(console.log("+++switch2",a.position.x,a.targetposition.x),a.targetposition.x=a.targetposition.x+o.children.length,a.position.x=a.position.x+o.children.length,a.pressOffset.x=a.pressOffset.x+o.children.length);var u=t;u>100&&(u=1),0==n.focused&&(u=t/2),(n.alwaysmove||n.contentsize.width!=n.size.width)&&(a.position.x=s(a.position.x,a.targetposition.x,u)),(n.alwaysmove||n.contentsize.height!=n.size.height)&&(a.position.y=s(a.position.y,a.targetposition.y,u)),0==n.focused&&a.position.x==a.targetposition.x&&a.position.y==a.targetposition.y&&(a.moving=!1),a.moving},n.getDistance=function(){var t=(a.position.x*n.itemsize+this.itemposition*n.itemsize)/screenWidth;return t},n.setContentSize=function(){n.contentsize.width=n.itemsize*o.children.length},n.add=function(t,e){var e=o.children.length,i=new focusable("carousel item container");return i.add(t),i.parent=o,o.children.push(i),o.drawTree=function(){function t(t,e){return Math.abs(t.dist)>Math.abs(e.dist)?-1:1}Math.min(sys.timestamp()-this.lastdraw,60);if(this.lastdraw=sys.timestamp(),0!=this.visible){if(this.update(),null!=this.preDraw&&this.preDraw(),null!=this.draw&&this.draw(),n.transition.order_draw){for(var e=[],i=0;i<this.children.length;i++)e.push(this.children[i]);e.sort(t);for(var i=0;i<e.length;i++)e[i].drawTree()}else if(this.reverseDrawOrder)for(var i=this.children.length-1;i>=0;i--)this.children[i].drawTree();else for(var i=0;i<this.children.length;i++)this.children[i].drawTree();null!=this.postDraw&&this.postDraw()}},t.carouselobject=i,i.index=e,i.child=t,i.itemposition=e,i.getDistance=n.getDistance,i.step=function(){var t=this.getDistance();if(this.dist=t,t<=-n.unload_distance||t>=n.unload_distance?null!=this.unload_content&&null!=this.content&&this.unload_content():null!=this.load_content&&null==this.content&&this.load_content(),this.active=!0,Math.abs(t)>.2&&(this.active=!1),this.visible=!0,Math.abs(t)>1&&(this.visible=!1),!(this.distance==t||Math.abs(t)>2)){this.distance=t;var e=n.transition;if(o.reverseDrawOrder=e.reverse_draw?!0:!1,t>=0)for(var i=0;i<e.show.length;i++){var r=e.show[i];"position.x"==r.target?this.position.x=r.func(r.startposition,r.endposition,Math.abs(1-t)):"position.y"==r.target?this.position.y=r.func(r.startposition,r.endposition,Math.abs(1-t)):"position.z"==r.target?this.position.z=r.func(r.startposition,r.endposition,Math.abs(1-t)):"scale.x"==r.target?this.scale.x=r.func(r.startposition,r.endposition,Math.abs(1-t)):"scale.y"==r.target?this.scale.y=r.func(r.startposition,r.endposition,Math.abs(1-t)):"rotate.x"==r.target?this.rotate.x=r.func(r.startposition,r.endposition,Math.abs(1-t)):"rotate.y"==r.target?this.rotate.y=r.func(r.startposition,r.endposition,Math.abs(1-t)):"rotate.z"==r.target?this.rotate.z=r.func(r.startposition,r.endposition,Math.abs(1-t)):"alpha"==r.target?this.alpha=r.func(r.startposition,r.endposition,Math.abs(1-t)):"transition_value"==r.target&&(this.transition_value=r.func(r.startposition,r.endposition,Math.abs(1-t)))}else for(var i=0;i<e.hide.length;i++){var a=e.hide[i];"position.x"==a.target?this.position.x=a.func(a.startposition,a.endposition,Math.abs(t)):"position.y"==a.target?this.position.y=a.func(a.startposition,a.endposition,Math.abs(t)):"position.z"==a.target?this.position.z=a.func(a.startposition,a.endposition,Math.abs(t)):"scale.x"==a.target?this.scale.x=a.func(a.startposition,a.endposition,Math.abs(t)):"scale.y"==a.target?this.scale.y=a.func(a.startposition,a.endposition,Math.abs(t)):"rotate.x"==a.target?this.rotate.x=a.func(a.startposition,a.endposition,Math.abs(t)):"rotate.y"==a.target?this.rotate.y=a.func(a.startposition,a.endposition,Math.abs(t)):"rotate.z"==a.target?this.rotate.z=a.func(a.startposition,a.endposition,Math.abs(t)):"alpha"==a.target?this.alpha=a.func(a.startposition,a.endposition,Math.abs(t)):"transition_value"==a.target&&(this.transition_value=a.func(a.startposition,a.endposition,Math.abs(t)))}}},o.itemaddposition=o.itemaddposition+1,n.setContentSize(),i},n};carousel["new"]=function(t,e,i){return new carousel(t,e,i)};var carousel_vertical=function(t,e,i){var n={name:"move in",show:[],hide:[]};n.show.push({target:"position.y",startposition:screenHeight,endposition:0,func:animator.outQuad}),n.show.push({target:"alpha",startposition:0,endposition:1,func:animator.outExpo}),n.hide.push({target:"position.y",startposition:0,endposition:0,func:animator.linear}),n.hide.push({target:"alpha",startposition:1,endposition:0,func:animator.inExpo});var r=new carousel(t,e,i);return r.itemsize=screenHeight,r.transition=n,r.getDistance=function(){var t=(r.instance.position.y*r.itemsize+this.itemposition*r.itemsize)/screenHeight;return t},r.setContentSize=function(){r.contentsize.height=r.itemsize*r.itemcontainer.children.length},r.focus=function(t,e){r.instance.moving&&(r.instance.moving=!1,r.instance.targetposition.x=r.instance.position.x,r.instance.targetposition.y=r.instance.position.y),r.instance.pressOffset={x:r.instance.targetposition.x-t*r.movespeed/screenWidth*2,y:r.instance.targetposition.y-e*r.movespeed/screenHeight*2},r.pressStarted={x:t,y:e}},r.focusdrag=function(t,e){var i=r.instance.pressOffset.x+t*r.movespeed/screenWidth*2,n=r.instance.pressOffset.y+e*r.movespeed/screenHeight*2,a=r.pressStarted.x-t,o=r.pressStarted.y-e;(r.alwaysmove||r.contentsize.height!=r.size.height)&&Math.abs(o)>r.movethreshold&&r.instance.setMoving(a,o),r.instance.moving&&(r.instance.targetposition.x=i,r.instance.targetposition.y=n)},r.defocus=function(){var t=Math.floor(-r.instance.targetposition.y+.5);r.moveToSelectedItem&&(r.instance.targetposition.y=-t),r.selecteditem=t,r.selecteditem<0&&(r.selecteditem=r.wrap?r.itemcontainer.children.length+t:0),r.selecteditem>r.itemcontainer.children.length-1&&(r.selecteditem=r.wrap?t-r.itemcontainer.children.length:r.itemcontainer.children.length-1),r.selecteditem=r.selecteditem+1,null!=r.carouselmoved&&r.carouselmoved(r.selecteditem)},r.moveto=function(t,e){r.instance.targetposition.y=-t,e&&(r.instance.position.y=r.instance.targetposition.y),r.selecteditem=t,null!=r.carouselmoved&&r.carouselmoved(t)},r};carousel_vertical["new"]=function(t,e,i){return new carousel_vertical(t,e,i)};var fbo_program={glProgram:null,getProgram:function(){return null==this.glProgram&&this.loadProgram(),this.glProgram},loadProgram:function(){var t={text:"        attribute vec2 a_position;        attribute vec2 a_tex_coordinate;                uniform mat4 u_projection;        uniform mat4 u_view;        uniform mat4 u_model;                varying vec2 v_tex_coord;                void main() {          gl_Position = u_projection*u_view*u_model*vec4(a_position, 0.0, 1.0);          v_tex_coord = vec2(a_tex_coordinate.x,1.0-a_tex_coordinate.y);        }        ",type:"x-shader/x-vertex"},e={text:"        precision mediump float;                varying vec2      v_tex_coord;                uniform sampler2D u_texture;        uniform float     u_alpha;                void main() {          vec4 color = texture2D(u_texture, v_tex_coord);          gl_FragColor = color * u_alpha;        }      ",type:"x-shader/x-fragment"},i=createShader(gl,t),n=createShader(gl,e);this.glProgram=loadProgram(gl,[i,n],["a_position","a_tex_coordinate"],["u_texture","u_alpha","u_model","u_view","u_projection"])}},fbo_object=function(t,e,i,n){var r=quad["new"]("fbo_object : "+t,e,i);r.glProgram=fbo_program.getProgram(),console.log("fbo_object.new(",r.dentifier,r.size.width,r.size.height,")"),r.dobypassFbo=!1,r.lastUpdated=-99999,r.updateInterval=0,r.framebuffer=gl.createFramebuffer(),r.framebuffer.width=r.size.width,r.framebuffer.height=r.size.height,gl.bindFramebuffer(gl.FRAMEBUFFER,r.framebuffer),r.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,r.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);var a=n?gl.RGB:gl.RGBA;return gl.texImage2D(gl.TEXTURE_2D,0,a,r.framebuffer.width,r.framebuffer.height,0,a,gl.UNSIGNED_BYTE,null),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,r.texture,0),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),r.preStep=function(){var t=sys.timestamp()-this.lastUpdated;this.fboUpdatesDisabled||this.dobypassFbo||t>=this.updateInterval&&r.updateFbo()},r.updateFbo=function(){scene.addFboUpdate(r)},r.renderFbo=function(){gl.bindTexture(gl.TEXTURE_2D,null);var t=gl.getParameter(gl.FRAMEBUFFER_BINDING),e=screenWidth,i=screenHeight,n=layoutWidth,a=layoutHeight,o={x:layoutOffset.x,y:layoutOffset.y};gl.viewport(0,0,r.size.width,r.size.height),gl.bindFramebuffer(gl.FRAMEBUFFER,r.framebuffer),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),screenWidth=r.size.width,screenHeight=r.size.height,layoutWidth=r.size.width,layoutHeight=r.size.height,layoutOffset={x:0,y:0};for(var s=0;s<r.children.length;s++)r.children[s].parent=null,r.children[s].viewMatrix=camera.viewMatrix,r.children[s].drawTree();screenWidth=e,screenHeight=i,layoutWidth=n,layoutHeight=a,layoutOffset=o,gl.viewport(layoutOffset.x,layoutOffset.y,layoutWidth,layoutHeight),gl.bindFramebuffer(gl.FRAMEBUFFER,t),r.lastUpdated=sys.timestamp()},r.drawTree=function(){Math.min(sys.timestamp()-this.lastdraw,60);if(this.lastdraw=sys.timestamp(),0!=this.visible){if(this.update(),this.dobypassFbo)for(var t=0;t<this.children.length;t++)this.children[t].parent=this,this.children[t].viewMatrix=this.modelViewMatrix,this.children[t].drawTree();else null!=this.draw&&this.draw();null!=this.postDraw&&this.postDraw()}},r.draw=function(){gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,r.texture),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var t=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,t),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,t.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,t.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,t.numItems)},r};fbo_object["new"]=function(t,e,i,n){return new fbo_object(t,e,i,n)};var focusable=function(t,e,i){var n=quad["new"](t,e,i);return n.focused=!1,n.hit=function(t,e){return t<-this.width()/2||t>this.width()/2||e<-this.height()/2||e>this.height()/2?!1:!0},n.relativePress=function(t,e){return this.hit(t,e)?(null!=this.focus&&this.focus(t,e),this.focused=!0,!0):!1},n.relativeDrag=function(t,e){return 1!=this.focused?!1:(1!=this.hit(t,e)?(null!=this.defocus&&this.defocus(t,e),this.focused=!1):null!=this.focusdrag&&this.focusdrag(t,e),!0)},n.relativeRelease=function(t,e){return 1!=this.focused?!1:(null!=this.click&&this.click(t,e),null!=this.defocus&&this.defocus(t,e),this.focused=!1,!0)},n.pointerReset=function(){null!=this.defocus&&this.defocus(0,0),this.focused=!1},n};focusable["new"]=function(t,e,i){return new focusable(t,e,i)};var fps={};fps.fpsCounter=0,fps.fpsTimestamp=0,fps.updateFps=function(){if(100==fps.fpsCounter){fps.fpsCounter=0;var t=sys.timestamp(),e=1e5/(t-fps.fpsTimestamp);console.log("FPS : "+e),fps.fpsTimestamp=t}fps.fpsCounter=fps.fpsCounter+1};var error=function(t){window.console&&(window.console.error?window.console.error(t):window.console.log&&window.console.log(t))},loadShader=function(t,e,i,n){var r=n||error,a=t.createShader(i);t.shaderSource(a,e),t.compileShader(a);var o=t.getShaderParameter(a,t.COMPILE_STATUS);return o?a:(lastError=t.getShaderInfoLog(a),r("*** Error compiling shader '"+a+"':"+lastError),t.deleteShader(a),null)},loadProgram=function(t,e,i,n){for(var r={},a=t.createProgram(),o=0;o<e.length;++o)t.attachShader(a,e[o]);t.linkProgram(a);var s=t.getProgramParameter(a,t.LINK_STATUS);if(!s)return lastError=t.getProgramInfoLog(a),error("Error in program linking:"+lastError),t.deleteProgram(a),null;if(i)for(var o=0;o<i.length;++o){var l=i[o]+"_handle";r[l]=t.getAttribLocation(a,i[o])}if(n)for(var o=0;o<n.length;++o){var l=n[o]+"_handle";r[l]=t.getUniformLocation(a,n[o])}return r.program=a,r},createShaderFromScript=function(t,e,i,n){var r,a="",o=document.getElementById(e);if(!o)throw"*** Error: unknown script element"+e;if(a=o.text,!i)if("x-shader/x-vertex"==o.type)r=t.VERTEX_SHADER;else if("x-shader/x-fragment"==o.type)r=t.FRAGMENT_SHADER;else if(r!=t.VERTEX_SHADER&&r!=t.FRAGMENT_SHADER)throw"*** Error: unknown shader type";return loadShader(t,a,i?i:r,n)},createShader=function(t,e,i,n){var r,a=e.text;if(!i)if("x-shader/x-vertex"==e.type)r=t.VERTEX_SHADER;else if("x-shader/x-fragment"==e.type)r=t.FRAGMENT_SHADER;else if(r!=t.VERTEX_SHADER&&r!=t.FRAGMENT_SHADER)throw"*** Error: unknown shader type";return loadShader(t,a,i?i:r,n)},image_program={glProgram:null,getProgram:function(){return null==this.glProgram&&this.loadProgram(),this.glProgram},loadProgram:function(){var t={text:"        attribute vec2 a_position;        attribute vec2 a_tex_coordinate;                uniform mat4 u_projection;        uniform mat4 u_view;        uniform mat4 u_model;                varying vec2 v_tex_coord;                void main() {          gl_Position = u_projection*u_view*u_model*vec4(a_position, 0.0, 1.0);          v_tex_coord = a_tex_coordinate;        }      ",type:"x-shader/x-vertex"},e={text:"        precision mediump float;                varying vec2      v_tex_coord;                uniform sampler2D u_texture;        uniform float     u_alpha;                void main() {          vec4 color = texture2D(u_texture, v_tex_coord);          gl_FragColor = color * u_alpha;        }      ",type:"x-shader/x-fragment"},i=createShader(gl,t),n=createShader(gl,e);this.glProgram=loadProgram(gl,[i,n],["a_position","a_tex_coordinate"],["u_texture","u_alpha","u_model","u_view","u_projection"])}},image={};image.loadImage=function(t){var e=null;if("string"==typeof t)if(console.log("image.new(",t,")",curlify.zipfile),e=new Image,null!=curlify.zipfile){var i=curlify.zipfile.file(t);e.src="data:image/jpg;base64,"+JSZip.base64.encode(i.asBinary())}else console.log("image source file"),e.crossOrigin="anonymous",e.src=t;return e},image["new"]=function(t,e){var i=e?e:quad["new"]("image : "+t);return i.size.width=null,i.size.height=null,t instanceof HTMLElement?(console.log("image.new from canvas",t),i.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,i.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,t),null==i.size.width&&(i.size.width=t.width),null==i.size.height&&(i.size.height=t.height),i.loaded=!0,null!=i.onload&&i.onload()):t instanceof Object?null!=t.texture||null!=t.size?(console.log("image.new from Object",t),i.texture=t.texture,i.image=t.image,null==i.size.width&&(i.size.width=t.size.width),null==i.size.height&&(i.size.height=t.size.height),i.loaded=!0,null!=i.onload&&i.onload()):console.log("ERROR: image.new from unknown Object",t):"string"==typeof t?(console.log("image.new from string",t),i.image=image.loadImage(t),i.image.onload=function(){return null==image?void console.log("image == null!"):(i.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,i.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,i.image),null==i.size.width&&(i.size.width=i.image.width),null==i.size.height&&(i.size.height=i.image.height),console.log("texture loaded : "+i.size.width+"x"+i.size.height),i.loaded=!0,void(null!=i.onload&&i.onload()))},i.image.onerror=function(){console.log("texture load failed",t)}):console.log("ERROR: image.new from unknown object",t),i};var jsonfile={json:null,open:function(t){var e={};if(null!=zip){var i=zip.file(t);null!=i&&(e=JSON.parse(i.asText()))}return this.json=e,this}},masked_image_program={program:null,getProgram:function(){return null==this.glProgram&&this.loadProgram(),this.glProgram},loadProgram:function(){var t={text:"      attribute vec2 a_position;       attribute vec2 a_tex_coordinate;             uniform mat4 u_projection;       uniform mat4 u_view;       uniform mat4 u_model;             varying vec2 v_tex_coord;             void main() {         gl_Position = u_projection*u_view*u_model*vec4(a_position, 0.0, 1.0);         v_tex_coord = a_tex_coordinate;       }       ",type:"x-shader/x-vertex"},e={text:"      precision mediump float;             varying vec2      v_tex_coord;             uniform sampler2D u_texture;       uniform sampler2D u_mask_texture;       uniform float     u_alpha;             void main() {                 vec4 color = texture2D(u_texture, v_tex_coord);         vec4 mask_color = texture2D(u_mask_texture, v_tex_coord);                 gl_FragColor = color * mask_color.a * u_alpha;       }       ",type:"x-shader/x-fragment"},i=createShader(gl,t),n=createShader(gl,e);this.glProgram=loadProgram(gl,[i,n],["a_position","a_tex_coordinate"],["u_texture","u_mask_texture","u_alpha","u_model","u_view","u_projection"])}},masked_image=function(t,e){var i=image["new"](t);return i.identifier="masked_image : "+t+" : "+e,console.log(i.identifier),i.mask=e,i.glProgram=masked_image_program.getProgram(),i.draw=function(){if(1==i.loaded){gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,i.texture),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,i.mask.texture),gl.uniform1i(this.glProgram.u_mask_texture_handle,1),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var t=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,t),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,t.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,t.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,t.numItems)}},i};masked_image["new"]=function(t,e){return new masked_image(t,e)};var object={};object["new"]=function(t,e,i){return{identifier:null==t?"object identifier":t,position:{x:0,y:0,z:0},rotate:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},size:{width:null==e?screenWidth:e,height:null==i?screenHeight:i},children:[],active:!0,visible:!0,alpha:1,blend:!0,drawbackside:!1,depthtest:!1,projectionMatrix:camera.projectionMatrix,viewMatrix:camera.viewMatrix,modelMatrix:mat4.identity(mat4.create()),modelViewMatrix:mat4.identity(mat4.create()),translateScale:camera.translateScale,identityMatrix:mat4.identity(mat4.create()),anim:new animator,timervalue:0,lastdraw:0,laststep:0,add:function(t){return t.parent=this,this.children.push(t),t},updateModelMatrix:function(){var t=this.modelMatrix;if(mat4.set(this.identityMatrix,t),0!=this.position.x||0!=this.position.y||0!=this.position.z){var e=screenWidth/(2*this.translateScale);mat4.translate(t,vec3.create([this.position.x/e,-this.position.y/e,this.position.z/e]))}0!=this.rotate.z&&mat4.rotateZ(t,-this.rotate.z),0!=this.rotate.y&&mat4.rotateY(t,-this.rotate.y),0!=this.rotate.x&&mat4.rotateX(t,-this.rotate.x),(1!=this.scale.x||1!=this.scale.y||1!=this.scale.z)&&mat4.scale(t,vec3.create([this.scale.x,this.scale.y,this.scale.z])),this.modelMatrix=t},update:function(){var t=this.viewMatrix;null!=this.parent&&null!=this.parent.modelViewMatrix&&(t=this.parent.modelViewMatrix),this.viewMatrix=t,this.updateModelMatrix(),this.children.length>0&&(mat4.set(this.viewMatrix,this.modelViewMatrix),mat4.multiply(this.modelViewMatrix,this.modelMatrix)),this.depthtest?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST),0==this.blend?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),1==this.drawbackside?gl.disable(gl.CULL_FACE):(gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT))},stepTree:function(){var t=Math.max(1,Math.min(sys.timestamp()-this.laststep,60));this.laststep=sys.timestamp(),this.anim.step(),null!=this.preStep&&this.preStep(),null!=this.step&&this.step(t);for(var e=0;e<this.children.length;e++)this.children[e].stepTree();null!=this.postStep&&this.postStep()},drawTree:function(){Math.min(sys.timestamp()-this.lastdraw,60);if(this.lastdraw=sys.timestamp(),0!=this.visible){if(this.update(),null!=this.preDraw&&this.preDraw(),null!=this.draw&&this.draw(),this.reverseDrawOrder)for(var t=this.children.length-1;t>=0;t--)this.children[t].drawTree();else for(var t=0;t<this.children.length;t++)this.children[t].drawTree();null!=this.postDraw&&this.postDraw()}},press:function(t,e){var i=!1;if(null!=this.relativePress){var n=t-screenWidth/2-this.absolutex(),r=e-screenHeight/2-this.absolutey();i=this.relativePress(n,r)}null!=this.absolutePress&&(i=this.absolutePress(t,e));for(var a=this.children.length-1;a>=0;a--)this.children[a].active&&(i=this.children[a].press(t,e));return i},drag:function(t,e){var i=!1;if(null!=this.relativeDrag){var n=t-screenWidth/2-this.absolutex(),r=e-screenHeight/2-this.absolutey();i=this.relativeDrag(n,r)}null!=this.absoluteDrag&&(i=this.absoluteDrag(t,e));for(var a=this.children.length-1;a>=0;a--)this.children[a].active&&(i=this.children[a].drag(t,e));return i},release:function(t,e){var i=!1;if(null!=this.relativeRelease){var n=t-screenWidth/2-this.absolutex(),r=e-screenHeight/2-this.absolutey();i=this.relativeRelease(n,r)}null!=this.absoluteRelease&&(i=this.absoluteRelease(t,e));for(var a=this.children.length-1;a>=0;a--)this.children[a].active&&(i=this.children[a].release(t,e));return i},resetpress:function(){if(1==this.active){for(var t=this.children.length-1;t>=0;t--)this.children[t].resetpress();this!=scene.getpointerStealer()&&null!=this.pointerReset&&this.pointerReset()}},x:function(){return this.position.x},y:function(){return this.position.y},width:function(){return this.size.width*this.scale.x},height:function(){return this.size.height*this.scale.y},top:function(){return this.position.y-this.height()/2},bottom:function(){return this.position.y+this.height()/2},left:function(){return this.position.x-this.width()/2},right:function(){return this.position.x+this.width()/2},absolutex:function(){var t=0;return null!=this.parent&&(t=this.parent.absolutex()),t+this.x()},absolutey:function(){var t=0;return null!=this.parent&&(t=this.parent.absolutey()),t+this.y()},absolutescalex:function(){var t=1;return null!=this.parent&&(t=this.parent.absolutescalex()),t*this.scale.x},absolutescaley:function(){var t=1;return null!=this.parent&&(t=this.parent.absolutescaley()),t*this.scale.y},absolutealpha:function(){var t=1;return null!=this.parent&&(t=this.parent.absolutealpha()),t*this.alpha},activate:function(){this.active=!0,null!=this.postActivate&&this.postActivate()},deactivate:function(){this.active=!1,null!=this.postDeactivate&&this.postDeactivate()
}}};var quad={};quad["new"]=function(t,e,i){null==quad.buffer&&(quad.buffer=gl.createBuffer(),quad.buffer.itemSize=2,quad.buffer.numItems=4,gl.bindBuffer(gl.ARRAY_BUFFER,quad.buffer),vertices=[-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1],gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW));var n=object["new"](t,e,i);return n.glProgram=image_program.getProgram(),n.quadModelMatrix=mat4.identity(mat4.create()),n.updateModelMatrix=function(){var t=this.modelMatrix;if(mat4.set(this.identityMatrix,t),0!=this.position.x||0!=this.position.y||0!=this.position.z){var e=screenWidth/(2*this.translateScale);mat4.translate(t,vec3.create([this.position.x/e,-this.position.y/e,this.position.z/e]))}0!=this.rotate.z&&mat4.rotateZ(t,-this.rotate.z),0!=this.rotate.y&&mat4.rotateY(t,-this.rotate.y),0!=this.rotate.x&&mat4.rotateX(t,-this.rotate.x),(1!=this.scale.x||1!=this.scale.y||1!=this.scale.z)&&mat4.scale(t,vec3.create([this.scale.x,this.scale.y,this.scale.z])),this.modelMatrix=t,mat4.set(this.modelMatrix,this.quadModelMatrix);var i=screenWidth/this.translateScale;mat4.scale(this.quadModelMatrix,vec3.create([this.size.width/i,-this.size.height/i,1]))},n.draw=function(){if(null!=n.texture){gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,n.texture),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var t=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,t),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,t.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,t.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,t.numItems)}},n};var rectangle_program={glProgram:null,getProgram:function(){return null==this.glProgram&&this.loadProgram(),this.glProgram},loadProgram:function(){var t={text:"        attribute vec2 a_position;                uniform mat4 u_projection;        uniform mat4 u_view;        uniform mat4 u_model;                void main() {          gl_Position = u_projection*u_view*u_model*vec4(a_position, 0.0, 1.0);        }",type:"x-shader/x-vertex"},e={text:"        precision mediump float;                uniform float     u_red;        uniform float     u_green;        uniform float     u_blue;        uniform float     u_alpha;                void main() {          gl_FragColor = vec4( u_red, u_green, u_blue, 1.0 ) * u_alpha;        }",type:"x-shader/x-fragment"},i=createShader(gl,t),n=createShader(gl,e);this.glProgram=loadProgram(gl,[i,n],["a_position"],["u_red","u_green","u_blue","u_alpha","u_model","u_view","u_projection"])}},rectangle=function(t,e,i){var n=quad["new"]("rectangle",t,e);return n.glProgram=rectangle_program.getProgram(),n.color=null==i?{red:0,green:0,blue:0}:i,n.draw=function(){gl.useProgram(this.glProgram.program),gl.uniform1f(this.glProgram.u_red_handle,this.color.red),gl.uniform1f(this.glProgram.u_green_handle,this.color.green),gl.uniform1f(this.glProgram.u_blue_handle,this.color.blue),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var t=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,t),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,t.itemSize,gl.FLOAT,!1,16,0),gl.drawArrays(gl.TRIANGLE_STRIP,0,t.numItems)},n};rectangle["new"]=function(t,e,i){return new rectangle(t,e,i)};var scrollable={};scrollable["new"]=function(t,e,i){var n=focusable["new"](t,e,i);n.contentsize={width:n.size.width,height:n.size.height},n.movespeed=1,n.movethreshold=40,n.swipespeed=(screenWidth+screenHeight)/2*5,n.maxspeed=200,n.inertia=7,n.zeroposition=0,n.loaddistance=screenHeight,n.visibledistance=n.loaddistance,n.itempad=0,n.centerslots=!1,n.swipefunc=animator.inQuad;var r=n.add(object["new"]("scrollable"));n.instance=r,r.targetposition={x:0,y:0,z:0};var a=function(t,e,i){i>100&&(i=100);var r=1;t>e&&(r=-1);var a=-r*(i/(16.66*n.inertia))*Math.abs(t-e),o=i/16.66*n.maxspeed;return a>o&&(a=o),-o>a&&(a=-o),Math.abs(a)<1e-5?t=e:t-=a,1==r&&t>e&&(t=e),-1==r&&e>t&&(t=e),t};n.focus=function(t,e){r.pressOffset={x:r.position.x-t*n.movespeed,y:r.position.y-e*n.movespeed},r.moving&&(r.resetpress(),r.moving=!1)},n.defocus=function(){scene.getpointerStealer()==n&&n.centeronslots(),console.log("DEFOCUS",n.identifier,r.position.y,r.targetposition.y)},n.centeronslots=function(){if(n.centerslots){var t=Math.floor(n.selected()/(screenWidth+n.itempad));n.movetox(t*(screenWidth+n.itempad)+screenWidth/2)}},r.setMoving=function(){0==r.moving&&null==scene.getpointerStealer()&&(scene.stealPointers(n),r.moving=!0)},n.focusdrag=function(t,e){var i=r.pressOffset.x+t*n.movespeed,a=r.pressOffset.y+e*n.movespeed,o=i-r.targetposition.x,s=a-r.targetposition.y;n.contentsize.width!=n.size.width&&Math.abs(o)>n.movethreshold&&r.setMoving(),n.contentsize.height!=n.size.height&&Math.abs(s)>n.movethreshold&&r.setMoving(),r.moving&&(r.targetposition.x=i,r.targetposition.y=a)},n.step=function(t){var e=-(n.contentsize.width-n.size.width)+n.zeroposition,i=-(n.contentsize.height-n.size.height),o=t;o>66&&(o=66),0!=n.enforcelimits&&(r.targetposition.x>n.size.width/4+n.zeroposition&&(r.targetposition.x=n.size.width/4+n.zeroposition),r.targetposition.y>n.size.height/4&&(r.targetposition.y=n.size.height/4),r.targetposition.x<e-n.size.width/4&&(r.targetposition.x=e-n.size.width/4),r.targetposition.y<i-n.size.height/4&&(r.targetposition.y=i-n.size.height/4),0==n.focused&&(r.targetposition.x>n.zeroposition&&(r.targetposition.x=a(r.targetposition.x,n.zeroposition,t/2)),r.targetposition.y>0&&(r.targetposition.y=a(r.targetposition.y,0,t/2)),r.targetposition.x<e&&(r.targetposition.x=a(r.targetposition.x,e,t/2)),r.targetposition.y<i&&(r.targetposition.y=a(r.targetposition.y,i,t/2)))),0==n.focused&&(o/=2),n.contentsize.width!=n.size.width&&(r.position.x=a(r.position.x,r.targetposition.x,o)),n.contentsize.height!=n.size.height&&(r.position.y=a(r.position.y,r.targetposition.y,o)),0==n.focused&&r.position.x==r.targetposition.x&&r.position.y==r.targetposition.y&&(r.moving=!1)},n.selected=function(){return Math.floor(r.targetposition.x)},n.movetox=function(t,e){e&&(r.position.x=t),r.targetposition.x=t},n.movetoy=function(t,e){e&&(r.position.y=t),r.targetposition.y=t},n.prepare=function(){n.step(0);for(var t=0;t<r.children.length;t++)r.children[t].step(0)};var o=4*screenWidth,s=4*screenHeight,l=-o,u=o,c=-s,h=s;return n.intersectsScreen=function(t){var e=t.absolutex(),i=t.absolutey(),n=e-t.width()/2,r=e+t.width()/2,a=i-t.height()/2,o=i+t.height()/2;return!(l>r||n>u||c>o||a>h)},n.add=function(t,e){e?e:r.children.length;return t.parent=r,r.children.push(t),t.step=function(){this.xdistance=this.absolutex();var t=Math.sqrt(Math.pow(this.xdistance,2)+Math.pow(this.absolutey(),2));if(t<n.loaddistance)null!=this.load_content&&0==this.loaded&&this.load_content();else{var e=n.unloaddistance;null==e&&(e=n.loaddistance),t>e&&null!=this.load_content&&null!=this.unload_content&&this.loaded&&this.unload_content()}this.visible=t<n.visibledistance?!0:!1,this.distance=t},t},n};var sprite={};sprite.newSheet=function(t,e,i){var n={spritewidth:0,spriteheight:0,frames:[]};if(t instanceof Array){var r=e,a=i,o=document.createElement("canvas");o.width=r,o.height=a;var s=o.getContext("2d");console.log("sprite.newSheet.onload",typeof o,o);for(var l=0,u=0;u<t.length;u++)!new function(){var e=image.loadImage(t[u]);e.onload=function(){s.drawImage(e,0,0),n.frames.push(image["new"](o)),s.clearRect(0,0,o.width,o.height),l+=1,l==t.length&&null!=n.onload&&n.onload()}};console.log("sprite.newSheet",t,t.length,e,i,n.frames.length),n.spritewidth=r,n.spriteheight=a,n.name="array "+t.length}else{var c=image.loadImage(t);c.onload=function(){var r=c.width/e,a=c.height/i,o=document.createElement("canvas");o.width=r,o.height=a;var s=o.getContext("2d");console.log("sprite.newSheet.onload",typeof o,o);for(var l=0;i>l;l++)for(var u=0;e>u;u++)s.drawImage(c,-u*r,-l*a),n.frames.push(image["new"](o)),s.clearRect(0,0,o.width,o.height);console.log("sprite.newSheet",t,c.width,c.height,e,i,n.frames.length),n.spritewidth=r,n.spriteheight=a,n.name=t,null!=n.onload&&n.onload()}}return n},sprite.newFromSheet=function(t,e,i,n,r){i=i?i:t.frames.length,n=n?n:0;for(var a=r?r:focusable["new"]("spritesheet "+t.name),o=n;n+i>o;o++){var s=a.add(image["new"](t.frames[o]));s.visible=!1,s.active=!1}return a.size.width=t.spritewidth,a.size.height=t.spriteheight,a.frame=a.children[0],a.frametimervalue=0,a.frametime=35,console.log("newFromSheet",t.name,n,i,a.children.length),a.restart=function(t){a.frametimervalue=0;var i=a.restart;0==e&&(i=null);var n=a.loopdelay&&!t?a.loopdelay:0;a.anim.animate(a,{frametimervalue:a.children.length,start:n,time:a.frametime*a.children.length,onComplete:i})},a.preStep=function(){a.frame.visible=!1;var t=Math.floor(a.frametimervalue);t>a.children.length-1||(a.frame=a.children[t],a.frame.visible=!0)},a.start=function(){return a.anim.animations.length>0&&a.anim.animations[0].paused?void a.anim.resume():void a.restart()},a.stop=function(){a.anim.pause()},a.unload=function(){a.anim.stop()},0!=e&&a.restart(!0),a},sprite["new"]=function(t,e,i,n,r,a){var o=sprite.newSheet(t,e,i),s=object["new"]("sprite loader");return s.sheet=o,o.onload=function(){sprite.newFromSheet(o,n,r,a,s),null!=s.onload&&s.onload()},s},sys={},sys.timestamp=function(){return(new Date).getTime()},sys.ismobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return sys.ismobile.Android()||sys.ismobile.BlackBerry()||sys.ismobile.iOS()||sys.ismobile.Opera()||sys.ismobile.Windows()}};var text=function(t,e,i,n,r,a){var r=r?r:screenWidth,o=quad["new"]("text : "+t+" : "+r+","+a);console.log("NEW TEXT: "+o.identifier),o.glProgram=image_program.getProgram(),o.canvas=document.createElement("canvas"),o.canvas.width=r,o.canvas.height=2*e,o.context=o.canvas.getContext("2d"),o.context.fillStyle="rgba("+255*n.red+","+255*n.green+","+255*n.blue+",255)",o.context.textAlign="center",o.context.textBaseline="middle",o.context.font=e+"px "+i;var s,l,u=[],c=e,h=r;createMultilineText(o.context,t,r,u);var g=h,d=c*(u.length+1);s=g/2;for(var m=.5*(d-c*(u.length+1)),p=0;p<u.length;p++)l=(p+1)*c+m,o.context.fillText(u[p],s,l),console.log(u[p],s,l);return o.size.width=o.canvas.width,o.size.height=o.canvas.height,o.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,o.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,o.canvas),o.draw=function(){gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,o.texture),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var t=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,t),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,t.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,t.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,t.numItems)},o};text["new"]=function(t,e,i,n,r,a){return new text(t,e,i,n,r,a)};var video=function(t){function e(){console.log("startVideo"),s.player.play()}function i(){console.log("videoDone")}function n(){console.log("progress")}function r(){console.log("playing")}function a(){console.log("stalling")}function o(){console.log("suspend")}var s=new focusable("video : "+t);s.glProgram=image_program.getProgram(),s.player=document.createElement("video");var l=!1;if(s.player.autoplay=!0,s.player.loop=!0,s.player.oncanplay=function(){l=!0},s.player.onerror=function(){var t="unknown error";switch(s.player.error.code){case 1:t="video loading aborted";break;case 2:t="network loading error";break;case 3:t="video decoding failed / corrupted data or unsupported codec";break;case 4:t="video not supported"}console.log("Error: "+t+" (errorcode="+s.player.error.code+")")},null!=zip&&"http"!=t.slice(0,4)){var u=zip.file(t);console.log("video.source zip",u,t,zip),s.player.type="video/mp4",s.player.src="data:video/mp4;base64,"+JSZip.base64.encode(u.asBinary())}else console.log("video.source ",t),s.player.src=t,s.player.crossOrigin="anonymous";return sys.ismobile.any()&&(s.click=function(t,e){console.log("video click",t,e),s.player.play()},s.focus=function(t,e){console.log("video focus",t,e)}),s.preload="auto",s.player.addEventListener("canplaythrough",e,!0),s.player.addEventListener("ended",i,!0),s.player.addEventListener("progress",n,!0),s.player.addEventListener("playing",r,!0),s.player.addEventListener("stalling",a,!0),s.player.addEventListener("suspend",o,!0),s.player.setAttribute("playsinline",""),s.player.setAttribute("webkit-playsinline",""),s.player.load(),s.player.play(),s.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,s.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),s.draw=function(){if(1!=s.loaded)return void(l&&(console.log("video texture loaded : "+s.size.width+"x"+s.size.height),null!=s.onload&&s.onload(),s.loaded=!0));gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,s.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,s.player),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var t=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,t),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,t.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,t.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,t.numItems)},s.checkstatus=function(){console.log("video status : "+s.player.paused+" : "+s.player.buffered+" : "+s.player.error),console.log("readyState  :"+s.player.readyState),console.log("startDate  :"+s.player.startDate),console.log("duration  :"+s.player.duration),console.log("currentSrc  :"+s.player.currentSrc),s.anim.animate(s,{alpha:1,time:2e3,onComplete:s.checkstatus})},s};video["new"]=function(t){return new video(t)};var viewWidth=null,viewHeight=null,screenWidth=null,screenHeight=null,gl=null,camera=null,scene=function(){var t=[],e=[],i=animator["new"](),n=null;return{render:function(){if(i.step(),i.animations.length>0){var n=t[t.length-2];n.stepTree(),n.drawTree()}var r=t[t.length-1];if(null!=r){r.stepTree(),r.drawTree();for(var a=0;a<e.length;a++)!new function(){var t=e[a];t.renderFbo()};e=[]}},openScene:function(e,n,r){var a=t[t.length-1];t.push(e),null!=n&&i.animate(e,n),null!=a&&null!=r&&i.animate(a,r)},closeScene:function(e,n){var r=t[t.length-1],a=t[t.length-2];if(null!=e){var o=e.onComplete,s=function(){null!=o&&o(),t.splice(t.length-1,1),console.log("remove scene from stack",r.identifier,t.length)};e.onComplete=s,i.animate(r,e)}else t.splice(t.length-1,1);null!=a&&null!=n&&i.animate(a,n)},isAnimating:function(){return i.animations.length>0?!0:!1},getPointerUser:function(){return n?n:t[t.length-1]},getpointerStealer:function(){return n},stealPointers:function(e){console.log("stealPointers",e);var i=n?n:t[t.length-1];n=e,i.resetpress()},resetPointerStealer:function(){n=null},addFboUpdate:function(t){e.push(t)}}}(),curlify=function(){function initWebGL(t){gl=null;try{gl=t.getContext("webgl")||t.getContext("experimental-webgl")}catch(e){}return gl||(alert("Unable to initialize WebGL. Your browser may not support it."),gl=null),gl}function mousedown(t){if(!scene.isAnimating()&&1!=touch){console.log("mousedown : "+t.clientX+","+t.clientY,layoutOffset.x,layoutOffset.y),touch=!0;var e=scene.getPointerUser();null!=e&&(e.press((t.clientX-layoutOffset.x)*layoutScale.x,(t.clientY-layoutOffset.y)*layoutScale.y),e.drag((t.clientX-layoutOffset.x)*layoutScale.x,(t.clientY-layoutOffset.y)*layoutScale.y))}}function mouseup(t){if(scene.resetPointerStealer(),!scene.isAnimating()&&0!=touch){console.log("mouseup : "+t.clientX+","+t.clientY),touch=!1;var e=scene.getPointerUser();null!=e&&e.release((t.clientX-layoutOffset.x)*layoutScale.x,(t.clientY-layoutOffset.y)*layoutScale.y)}}function mouseout(t){touch&&mouseup(t)}function mousemove(t){if(!scene.isAnimating()&&0!=touch){var e=scene.getPointerUser();null!=e&&touch&&e.drag((t.clientX-layoutOffset.x)*layoutScale.x,(t.clientY-layoutOffset.y)*layoutScale.y)}}function touchstart(t){if(!scene.isAnimating()&&1!=touch){touch=!0;var e=scene.getPointerUser();null!=e&&(e.press((t.touches[0].pageX-layoutOffset.x)*layoutScale.x,(t.touches[0].pageY-layoutOffset.y)*layoutScale.y),e.drag((t.touches[0].pageX-layoutOffset.x)*layoutScale.x,(t.touches[0].pageY-layoutOffset.y)*layoutScale.y),lasttouch=t)}}function touchend(){if(scene.resetPointerStealer(),!scene.isAnimating()&&0!=touch){touch=!1;var t=scene.getPointerUser();null!=t&&t.release(lasttouch.touches[0].pageX-layoutOffset.x,lasttouch.touches[0].pageY-layoutOffset.y)}}function touchmove(t){if(t.preventDefault(),!scene.isAnimating()&&0!=touch){var e=scene.getPointerUser();null!=e&&(touch&&e.drag((t.touches[0].pageX-layoutOffset.x)*layoutScale.x,(t.touches[0].pageY-layoutOffset.y)*layoutScale.y),lasttouch=t)}}function deviceMotionHandler(t){instance.sensors.acceleration=t.acceleration,instance.sensors.rotation=t.rotationRate}function deviceOrientationHandler(t){instance.sensors.orientation=t}function render(){gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT),gl.viewport(layoutOffset.x,layoutOffset.y,layoutWidth,layoutHeight),scene.render()}function orientationChanged(){console.log("ORIENTATION CHANGED")}function resizeCanvas(){var t=glcanvas.clientWidth,e=glcanvas.clientHeight;if(glcanvas.width!=t||glcanvas.height!=e){layoutWidth=t,layoutHeight=e,layoutScale={x:screenWidth/layoutWidth,y:screenHeight/layoutHeight},viewWidth=screenWidth,viewHeight=screenHeight;var i=Math.max(layoutScale.x,layoutScale.y);aspectratioZoom&&(i=Math.min(layoutScale.x,layoutScale.y),viewWidth=t*i,viewHeight=e*i),layoutScale.x=i,layoutScale.y=i,layoutWidth=Math.floor(screenWidth*(1/i)),layoutHeight=Math.floor(screenHeight*(1/i)),layoutOffset.x=(t-layoutWidth)/2,layoutOffset.y=(e-layoutHeight)/2,glcanvas.width=glcanvas.clientWidth,glcanvas.height=glcanvas.clientHeight,console.log("resized",glcanvas.width,glcanvas.height,viewWidth,viewHeight)}console.log("resizeCanvas",glcanvas.clientWidth,glcanvas.clientHeight,screenWidth,screenHeight,glcanvas.width,glcanvas.height)}function MergeRecursive(t,e){for(var i in e)try{t[i]=e[i].constructor==Object?MergeRecursive(t[i],e[i]):e[i]}catch(n){t[i]=e[i]}return t}var glcanvas,layoutWidth=null,layoutHeight=null,layoutOffset={x:0,y:0},layoutScale={x:1,y:1},aspectratioZoom=!0,touch=!1,lasttouch=null,instance={};instance.sensors={acceleration:null,rotation:null,orientation:null},instance.zipfile=null;var createProjection=function(t,e,i,n){var r=mat4.create();return r[0]=i/t,r[5]=i/e,r[10]=-(n+i)/(n-i),r[11]=-1,r[14]=-2*n*i/(n-i),r},createProjectionAndView=function(t,e,i,n){var r=createProjection(1,e/t,i,n),a=mat4.identity(mat4.create());mat4.translate(a,vec3.create([0,0,-(n-i)/2]));var o=(n-i)/2/i,s={near:i,far:n,width:t,height:e,projectionMatrix:r,viewMatrix:a,translateScale:o};return s};return instance.assert=function(t,e){if(!t)throw e||"Assertion failed"},instance.require=function(script,callback){if(console.log("require(",script,")"),".zip"==script.slice(-4))JSZipUtils.getBinaryContent(script,function(err,data){if(err)return void console.log("ERROR: unable to load script zip",script,err);instance.zipfile=new JSZip(data),console.log("zip loaded : ",instance.zipfile.files);var adscriptfile=instance.zipfile.file("main.js");if(console.log(adscriptfile),null==adscriptfile)return console.log("ERROR: no main.js found in zip"),void(instance.zipfile=null);var scriptid=script.replace("/","_"),element=document.createElement("script");element.text=adscriptfile.asText(),element.setAttribute("id",scriptid),element.setAttribute("type","text/javascript"),document.head.appendChild(element),callback(eval("cmsscript"))});else{var scriptid=script.replace("/","_"),element=document.getElementById(scriptid);null==element?(console.log("create element",script,scriptid),element=document.createElement("script"),element.setAttribute("src",script+".js"),element.setAttribute("id",scriptid),element.setAttribute("type","text/javascript"),element.onload=function(){callback(eval(script))},document.head.appendChild(element)):null!=callback&&callback(eval(script))}},instance.createCORSRequest=function(t,e){var i=new XMLHttpRequest;return"withCredentials"in i?i.open(t,e,!0):"undefined"!=typeof XDomainRequest?(i=new XDomainRequest,i.open(t,e)):i=null,i},instance.getRandom=function(t,e){return Math.floor(Math.random()*(e-t)+t)},instance.start=function(t,e,i,n){glcanvas=document.getElementById(t),screenWidth=i?i:480,screenHeight=n?n:852,"ontouchstart"in window?(console.log("USE TOUCH MOUSE"),glcanvas.addEventListener("touchstart",touchstart,!1),glcanvas.addEventListener("touchmove",touchmove,!1),glcanvas.addEventListener("touchend",touchend,!1)):(console.log("USE REGULAR MOUSE"),glcanvas.addEventListener("mousedown",mousedown,!1),glcanvas.addEventListener("mousemove",mousemove,!1),glcanvas.addEventListener("mouseup",mouseup,!1)),gl=initWebGL(glcanvas),resizeCanvas(),camera=createProjectionAndView(screenWidth,screenHeight,3,100),gl&&(window.DeviceMotionEvent?window.addEventListener("devicemotion",deviceMotionHandler,!1):alert("DeviceMotionEvent not supported"),window.DeviceOrientationEvent?window.addEventListener("deviceorientation",deviceOrientationHandler,!1):alert("DeviceOrientationEvent not supported"),window.addEventListener("orientationchange",orientationChanged),console.log("start script",e),instance.require(e,function(t){scene.openScene(t["new"]());setInterval(render,1e3/60)}))},instance}();