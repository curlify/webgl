function createMultilineText(e,t,i,n){t=t.replace("\n"," ");var a,r,o,s=t,l=0,c=0,u=t.split(" ");for(r=o=u.length;e.measureText(s).width>i&&r>1;){r--;s=a="";for(var h=0;o>h;h++)r>h?(s+=u[h],r>h+1&&(s+=" ")):(a+=u[h],o>h+1&&(a+=" "))}return n.push(s),c=e.measureText(s),a&&(l=createMultilineText(e,a,i,n),l>c&&(c=l)),c}var animator=function(){var e={time:!0,ease:!0,start:!0,onComplete:!0};return{animations:[],animate:function(t,i){null==i.ease&&(i.ease=animator.linear),null==i.start&&(i.start=0);var n={};for(var a in i){{i[a]}null==e[a]&&(curlify.assert(null!=t[a],"Animated property cannot be initially nil : "+a),n[a]=t[a])}this.animations.push({target:t,start:sys.timestamp()+i.start,deadline:sys.timestamp()+i.start+i.time,config:i,init:n})},step:function(){var e=[],t=sys.timestamp();for(var n in this.animations){var a=this.animations[n],r=(a.deadline,0);1==a.paused&&(t=a.pausetimestamp),t<a.deadline?r=1-(a.deadline-t)/a.config.time:t<a.start?r=0:(r=1,e.push(n)),r=Math.max(r,1e-5);for(var n in a.init)initial=a.init[n],a.target[n]=a.config.ease(initial,a.config[n],r)}for(i=e.length-1;i>=0;i--){var o=this.animations[e[i]].config.onComplete;this.animations.splice(e[i],1),null!=o&&o()}},pause:function(){for(var e in this.animations)this.animations[e].paused=!0,this.animations[e].pausetimestamp=sys.timestamp()},resume:function(){for(var e in this.animations)this.animations[e].paused=!1,this.animations[e].deadline=this.animations[e].deadline+(sys.timestamp()-self.animations[e].pausetimestamp)},stop:function(){for(var e in this.animations)this.animations[e].init={},this.animations[e].config.onComplete=null;this.animations=[]}}};animator.linear=function(e,t,i){return e+(t-e)*i},animator.inQuad=function(e,t,i){return e+(t-e)*i*i},animator.outQuad=function(e,t,i){return e+-(t-e)*i*(i-2)},animator.inOutQuad=function(e,t,i){return.5>i?(i=2*i,e+(t-e)/2*i*i):(i=2*(i-.5),e-(t-e)/2*(i*(i-2)-1))},animator.inCubic=function(e,t,i){return e+(t-e)*i*i*i},animator.outCubic=function(e,t,i){return i-=1,e+(t-e)*(i*i*i+1)},animator.inOutCubic=function(e,t,i){return.5>i?(i=2*i,e+(t-e)/2*i*i*i):(i=2*(i-.5)-1,e+(t-e)/2*(i*i*i+2))},animator.inQuart=function(e,t,i){return e+(t-e)*i*i*i*i},animator.outQuart=function(e,t,i){return i-=1,e-(t-e)*(i*i*i*i-1)},animator.inOutQuart=function(e,t,i){return.5>i?(i=2*i,e+(t-e)/2*i*i*i*i):(i=2*(i-.5)-1,e-(t-e)/2*(i*i*i*i-2))},animator.inSine=function(e,t,i){return e+(t-e)*(1-Math.cos(i*Math.pi/2))},animator.outSine=function(e,t,i){return e+(t-e)*Math.sin(i*Math.pi/2)},animator.inOutSine=function(e,t,i){return e-(t-e)/2*(Math.cos(Math.pi*i)-1)},animator.inExpo=function(e,t,i){return i-=1,e+(t-e)*Math.pow(2,10*i)},animator.outExpo=function(e,t,i){return e+(t-e)*(1-Math.pow(2,-10*i))},animator.inOutExpo=function(e,t,i){return.5>i?(i=2*i-1,e+(t-e)/2*Math.pow(2,10*i)):(i=2*(i-.5),e+(t-e)/2*(2-Math.pow(2,-10*i)))},animator.inCirc=function(e,t,i){return e+(t-e)*(1-Math.sqrt(1-i*i))},animator.outCirc=function(e,t,i){return i-=1,e+(t-e)*Math.sqrt(1-i*i)},animator.inOutCirc=function(e,t,i){return.5>i?(i=2*i,e+(t-e)/2*(1-Math.sqrt(1-i*i))):(i=2*(i-.5)-1,e+(t-e)/2*(1+Math.sqrt(1-i*i)))},animator.inElastic=function(e,t,i){return i-=1,e-(t-e)*Math.pow(2,10*i)*Math.sin(6*(i-.0777777)*Math.pi)},animator.outElastic=function(e,t,i){return e+(t-e)*(Math.pow(2,-10*i)*Math.sin(6*(i-.0777777)*Math.pi)+1)},animator["new"]=function(){return new animator};var button=function(e){var t=image["new"](e);return t.focused=!1,t.identifier="button : "+e,t.hit=function(e,t){return e<-this.width()/2||e>this.width()/2||t<-this.height()/2||t>this.height()/2?!1:!0},t.relativePress=function(e,t){return this.hit(e,t)?(null!=this.focus&&this.focus(e,t),this.focused=!0,!0):!1},t.relativeDrag=function(e,t){return 1!=this.focused?!1:(1!=this.hit(e,t)?(null!=this.defocus&&this.defocus(e,t),this.focused=!1):null!=this.focusdrag&&this.focusdrag(e,t),!0)},t.relativeRelease=function(e,t){return 1!=this.focused?!1:(null!=this.click&&this.click(e,t),null!=this.defocus&&this.defocus(e,t),this.focused=!1,!0)},t.pointerReset=function(){null!=this.defocus&&this.defocus(0,0),this.focused=!1},t};button["new"]=function(e){return new button(e)};var carousel={};carousel["new"]=function(e,t,i){var n=focusable["new"](e,t,i),a={name:"coverflow",show:[],hide:[]};a.show.push({target:"position.x",startposition:1*screenWidth,endposition:0,func:animator.linear}),a.show.push({target:"rotate.y",startposition:.8*Math.PI,endposition:0,func:animator.linear}),a.show.push({target:"scale.x",startposition:.6,endposition:1,func:animator.linear}),a.show.push({target:"scale.y",startposition:.6,endposition:1,func:animator.linear}),a.hide.push({target:"position.x",startposition:0,endposition:1*-screenWidth,func:animator.linear}),a.hide.push({target:"rotate.y",startposition:0,endposition:.8*-Math.PI,func:animator.linear}),a.hide.push({target:"scale.x",startposition:1,endposition:.6,func:animator.linear}),a.hide.push({target:"scale.y",startposition:1,endposition:.6,func:animator.linear}),n.contentsize={width:n.size.width,height:n.size.height},n.inertia=5,n.swipespeed=screenWidth,n.movespeed=1,n.movethreshold=60,n.itemsize=screenWidth,n.transition=a,n.unload_distance=1,n.wrap=!1,n.bounceOnWrap=!1,n.alwaysmove=!1,n.nevermove=!1,n.selecteditem=1,n.moveToSelectedItem=!0;var r=n.add(object["new"]("carousel"));r.targetposition={x:0,y:0,z:0},r.pressOffset={x:0,y:0};var o=n.add(object["new"]("item container"));o.targetposition={x:0,y:0,z:0},n.instance=r,n.itemcontainer=o;var s=function(e,t,i){i>100&&(i=100);var a=1;e>t&&(a=-1);var r=-a*i/(16.66*n.inertia)*Math.abs(e-t);return Math.abs(r)<1e-4?e=t:e-=r,1==a&&e>t&&(e=t),-1==a&&t>e&&(e=t),e};return r.setMoving=function(e,t){null==scene.getpointerStealer()&&1!=n.nevermove&&(scene.stealPointers(n),null!=n.stolePointers&&n.stolePointers(e,t),r.moving=!0)},n.focus=function(e,t){r.moving&&(r.moving=!1,r.targetposition.x=r.position.x,r.targetposition.y=r.position.y),r.pressOffset={x:r.targetposition.x-e*n.movespeed/screenWidth*2,y:r.targetposition.y-t*n.movespeed},n.pressStarted={x:e,y:t}},n.focusdrag=function(e,t){var i=r.pressOffset.x+e*n.movespeed/screenWidth*2,a=r.pressOffset.y+t*n.movespeed/screenHeight*2,o=n.pressStarted.x-e,s=n.pressStarted.y-t;(n.alwaysmove||n.contentsize.width!=n.size.width)&&Math.abs(o)>n.movethreshold&&r.setMoving(o,s),r.moving&&(r.targetposition.x=i,r.targetposition.y=a)},n.defocus=function(){var e=Math.floor(-r.targetposition.x+.5);n.moveToSelectedItem&&(r.targetposition.x=-e),n.selecteditem=e,n.selecteditem<0&&(n.selecteditem=n.wrap?o.children.length+e:0),n.selecteditem>o.children.length-1&&(n.selecteditem=n.wrap?e-o.children.length:o.children.length-1),n.selecteditem=n.selecteditem+1,null!=n.carouselmoved&&n.carouselmoved(n.selecteditem)},n.postDraw=function(){if(n.wrap)for(var e=0;e<o.children.length;e++){var t=o.children[e],i=t.active,a=t.visible,r=t.itemposition;t.itemposition=r+o.children.length,t.stepTree(),t.drawTree(),t.itemposition=r-o.children.length,t.stepTree(),t.drawTree(),t.itemposition=r,t.step(0),t.visible=a,t.active=i}},n.selected=function(){return n.selecteditem},n.getItem=function(e){return o.children[e-1]},n.moveto=function(e,t){r.targetposition.x=-e,t&&(r.position.x=r.targetposition.x),n.selecteditem=e,null!=n.carouselmoved&&n.carouselmoved(e+1)},n.step=function(e){var t=-o.children.length+1,i=-o.children.length+1,a=.75,l=.75;0==n.wrap||n.bounceOnWrap&&r.position.x>t-a&&r.position.x<a?(n.bounceOnWrap&&(a=2*a,l=2*l),r.targetposition.x>a&&(r.targetposition.x=a),r.targetposition.y>l&&(r.targetposition.y=l),r.targetposition.x<t-a&&(r.targetposition.x=t-a),r.targetposition.y<i-l&&(r.targetposition.y=i-l),0==n.focused&&(r.targetposition.x>0&&(r.targetposition.x=s(r.targetposition.x,0,e/2)),r.targetposition.y>0&&(r.targetposition.y=s(r.targetposition.y,0,e/2)),r.targetposition.x<t&&(r.targetposition.x=s(r.targetposition.x,t,e/2)),r.targetposition.y<i&&(r.targetposition.y=s(r.targetposition.y,i,e/2)))):r.targetposition.x>1?(console.log("switch",r.position.x,r.targetposition.x,n.contentsize.width),r.targetposition.x=r.targetposition.x-o.children.length,r.position.x=r.position.x-o.children.length,r.pressOffset.x=r.pressOffset.x-o.children.length):r.targetposition.x<-o.children.length&&(console.log("+++switch2",r.position.x,r.targetposition.x),r.targetposition.x=r.targetposition.x+o.children.length,r.position.x=r.position.x+o.children.length,r.pressOffset.x=r.pressOffset.x+o.children.length);var c=e;c>100&&(c=1),0==n.focused&&(c=e/2),(n.alwaysmove||n.contentsize.width!=n.size.width)&&(r.position.x=s(r.position.x,r.targetposition.x,c)),(n.alwaysmove||n.contentsize.height!=n.size.height)&&(r.position.y=s(r.position.y,r.targetposition.y,c)),0==n.focused&&r.position.x==r.targetposition.x&&r.position.y==r.targetposition.y&&(r.moving=!1),r.moving},n.getDistance=function(){var e=(r.position.x*n.itemsize+this.itemposition*n.itemsize)/screenWidth;return e},n.setContentSize=function(){n.contentsize.width=n.itemsize*o.children.length},n.add=function(e,t){var t=o.children.length,i=focusable["new"]("carousel item container");return i.add(e),i.parent=o,o.children.push(i),o.drawTree=function(){function e(e,t){return Math.abs(e.dist)>Math.abs(t.dist)?-1:1}Math.min(sys.timestamp()-this.lastdraw,60);if(this.lastdraw=sys.timestamp(),0!=this.visible){if(this.update(),null!=this.preDraw&&this.preDraw(),null!=this.draw&&this.draw(),n.transition.order_draw){for(var t=[],i=0;i<this.children.length;i++)t.push(this.children[i]);t.sort(e);for(var i=0;i<t.length;i++)t[i].drawTree()}else if(this.reverseDrawOrder)for(var i=this.children.length-1;i>=0;i--)this.children[i].drawTree();else for(var i=0;i<this.children.length;i++)this.children[i].drawTree();null!=this.postDraw&&this.postDraw()}},e.carouselobject=i,i.index=t,i.child=e,i.itemposition=t,i.getDistance=n.getDistance,i.step=function(){var e=this.getDistance();if(this.dist=e,e<=-n.unload_distance||e>=n.unload_distance?null!=this.unload_content&&null!=this.content&&this.unload_content():null!=this.load_content&&null==this.content&&this.load_content(),this.active=!0,Math.abs(e)>.2&&(this.active=!1),this.visible=!0,Math.abs(e)>1&&(this.visible=!1),!(this.distance==e||Math.abs(e)>2)){this.distance=e;var t=n.transition;if(o.reverseDrawOrder=t.reverse_draw?!0:!1,e>=0)for(var i=0;i<t.show.length;i++){var a=t.show[i];"position.x"==a.target?this.position.x=a.func(a.startposition,a.endposition,Math.abs(1-e)):"position.y"==a.target?this.position.y=a.func(a.startposition,a.endposition,Math.abs(1-e)):"position.z"==a.target?this.position.z=a.func(a.startposition,a.endposition,Math.abs(1-e)):"scale.x"==a.target?this.scale.x=a.func(a.startposition,a.endposition,Math.abs(1-e)):"scale.y"==a.target?this.scale.y=a.func(a.startposition,a.endposition,Math.abs(1-e)):"rotate.x"==a.target?this.rotate.x=a.func(a.startposition,a.endposition,Math.abs(1-e)):"rotate.y"==a.target?this.rotate.y=a.func(a.startposition,a.endposition,Math.abs(1-e)):"rotate.z"==a.target?this.rotate.z=a.func(a.startposition,a.endposition,Math.abs(1-e)):"alpha"==a.target?this.alpha=a.func(a.startposition,a.endposition,Math.abs(1-e)):"transition_value"==a.target&&(this.transition_value=a.func(a.startposition,a.endposition,Math.abs(1-e)))}else for(var i=0;i<t.hide.length;i++){var r=t.hide[i];"position.x"==r.target?this.position.x=r.func(r.startposition,r.endposition,Math.abs(e)):"position.y"==r.target?this.position.y=r.func(r.startposition,r.endposition,Math.abs(e)):"position.z"==r.target?this.position.z=r.func(r.startposition,r.endposition,Math.abs(e)):"scale.x"==r.target?this.scale.x=r.func(r.startposition,r.endposition,Math.abs(e)):"scale.y"==r.target?this.scale.y=r.func(r.startposition,r.endposition,Math.abs(e)):"rotate.x"==r.target?this.rotate.x=r.func(r.startposition,r.endposition,Math.abs(e)):"rotate.y"==r.target?this.rotate.y=r.func(r.startposition,r.endposition,Math.abs(e)):"rotate.z"==r.target?this.rotate.z=r.func(r.startposition,r.endposition,Math.abs(e)):"alpha"==r.target?this.alpha=r.func(r.startposition,r.endposition,Math.abs(e)):"transition_value"==r.target&&(this.transition_value=r.func(r.startposition,r.endposition,Math.abs(e)))}}},o.itemaddposition=o.itemaddposition+1,n.setContentSize(),i},n};var carousel_vertical=function(e,t,i){var n={name:"move in",show:[],hide:[]};n.show.push({target:"position.y",startposition:screenHeight,endposition:0,func:animator.outQuad}),n.show.push({target:"alpha",startposition:0,endposition:1,func:animator.outExpo}),n.hide.push({target:"position.y",startposition:0,endposition:0,func:animator.linear}),n.hide.push({target:"alpha",startposition:1,endposition:0,func:animator.inExpo});var a=carousel["new"](e,t,i);return a.itemsize=screenHeight,a.transition=n,a.getDistance=function(){var e=(a.instance.position.y*a.itemsize+this.itemposition*a.itemsize)/screenHeight;return e},a.setContentSize=function(){a.contentsize.height=a.itemsize*a.itemcontainer.children.length},a.focus=function(e,t){a.instance.moving&&(a.instance.moving=!1,a.instance.targetposition.x=a.instance.position.x,a.instance.targetposition.y=a.instance.position.y),a.instance.pressOffset={x:a.instance.targetposition.x-e*a.movespeed/screenWidth*2,y:a.instance.targetposition.y-t*a.movespeed/screenHeight*2},a.pressStarted={x:e,y:t}},a.focusdrag=function(e,t){var i=a.instance.pressOffset.x+e*a.movespeed/screenWidth*2,n=a.instance.pressOffset.y+t*a.movespeed/screenHeight*2,r=a.pressStarted.x-e,o=a.pressStarted.y-t;(a.alwaysmove||a.contentsize.height!=a.size.height)&&Math.abs(o)>a.movethreshold&&a.instance.setMoving(r,o),a.instance.moving&&(a.instance.targetposition.x=i,a.instance.targetposition.y=n)},a.defocus=function(){var e=Math.floor(-a.instance.targetposition.y+.5);a.moveToSelectedItem&&(a.instance.targetposition.y=-e),a.selecteditem=e,a.selecteditem<0&&(a.selecteditem=a.wrap?a.itemcontainer.children.length+e:0),a.selecteditem>a.itemcontainer.children.length-1&&(a.selecteditem=a.wrap?e-a.itemcontainer.children.length:a.itemcontainer.children.length-1),a.selecteditem=a.selecteditem+1,null!=a.carouselmoved&&a.carouselmoved(a.selecteditem)},a.moveto=function(e,t){a.instance.targetposition.y=-e,t&&(a.instance.position.y=a.instance.targetposition.y),a.selecteditem=e,null!=a.carouselmoved&&a.carouselmoved(e)},a};carousel_vertical["new"]=function(e,t,i){return new carousel_vertical(e,t,i)};var fbo_program={glProgram:null,getProgram:function(){return null==this.glProgram&&this.loadProgram(),this.glProgram},loadProgram:function(){var e={text:"        attribute vec2 a_position;        attribute vec2 a_tex_coordinate;                uniform mat4 u_projection;        uniform mat4 u_view;        uniform mat4 u_model;                varying vec2 v_tex_coord;                void main() {          gl_Position = u_projection*u_view*u_model*vec4(a_position, 0.0, 1.0);          v_tex_coord = vec2(a_tex_coordinate.x,1.0-a_tex_coordinate.y);        }        ",type:"x-shader/x-vertex"},t={text:"        precision mediump float;                varying vec2      v_tex_coord;                uniform sampler2D u_texture;        uniform float     u_alpha;                void main() {          vec4 color = texture2D(u_texture, v_tex_coord);          gl_FragColor = color * u_alpha;        }      ",type:"x-shader/x-fragment"},i=createShader(gl,e),n=createShader(gl,t);this.glProgram=loadProgram(gl,[i,n],["a_position","a_tex_coordinate"],["u_texture","u_alpha","u_model","u_view","u_projection"])}},fbo_object=function(e,t,i,n){var a=quad["new"]("fbo_object : "+e,t,i);a.glProgram=fbo_program.getProgram(),console.log("fbo_object.new(",a.dentifier,a.size.width,a.size.height,")"),a.dobypassFbo=!1,a.lastUpdated=-99999,a.updateInterval=0,a.framebuffer=gl.createFramebuffer(),a.framebuffer.width=a.size.width,a.framebuffer.height=a.size.height,gl.bindFramebuffer(gl.FRAMEBUFFER,a.framebuffer),a.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,a.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);var r=n?gl.RGB:gl.RGBA;return gl.texImage2D(gl.TEXTURE_2D,0,r,a.framebuffer.width,a.framebuffer.height,0,r,gl.UNSIGNED_BYTE,null),gl.framebufferTexture2D(gl.FRAMEBUFFER,gl.COLOR_ATTACHMENT0,gl.TEXTURE_2D,a.texture,0),gl.bindTexture(gl.TEXTURE_2D,null),gl.bindFramebuffer(gl.FRAMEBUFFER,null),a.preStep=function(){var e=sys.timestamp()-this.lastUpdated;this.fboUpdatesDisabled||this.dobypassFbo||e>=this.updateInterval&&a.updateFbo()},a.updateFbo=function(){scene.addFboUpdate(a)},a.renderFbo=function(){gl.bindTexture(gl.TEXTURE_2D,null);var e=gl.getParameter(gl.FRAMEBUFFER_BINDING),t=screenWidth,i=screenHeight,n=curlify.layoutWidth,r=curlify.layoutHeight,o={x:curlify.layoutOffset.x,y:curlify.layoutOffset.y};gl.viewport(0,0,a.size.width,a.size.height),gl.bindFramebuffer(gl.FRAMEBUFFER,a.framebuffer),gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),screenWidth=a.size.width,screenHeight=a.size.height,curlify.layoutWidth=a.size.width,curlify.layoutHeight=a.size.height,curlify.layoutOffset={x:0,y:0};for(var s=0;s<a.children.length;s++)a.children[s].parent=null,a.children[s].viewMatrix=curlify.camera.viewMatrix,a.children[s].drawTree();screenWidth=t,screenHeight=i,curlify.layoutWidth=n,curlify.layoutHeight=r,curlify.layoutOffset=o,gl.viewport(curlify.layoutOffset.x,curlify.layoutOffset.y,curlify.layoutWidth,curlify.layoutHeight),gl.bindFramebuffer(gl.FRAMEBUFFER,e),a.lastUpdated=sys.timestamp()},a.drawTree=function(){Math.min(sys.timestamp()-this.lastdraw,60);if(this.lastdraw=sys.timestamp(),0!=this.visible){if(this.update(),this.dobypassFbo)for(var e=0;e<this.children.length;e++)this.children[e].parent=this,this.children[e].viewMatrix=this.modelViewMatrix,this.children[e].drawTree();else null!=this.draw&&this.draw();null!=this.postDraw&&this.postDraw()}},a.draw=function(){gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,a.texture),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var e=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,e.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,e.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,e.numItems)},a};fbo_object["new"]=function(e,t,i,n){return new fbo_object(e,t,i,n)};var focusable={};focusable["new"]=function(e,t,i){var n=quad["new"](e,t,i);return n.focused=!1,n.hit=function(e,t){return e<-this.width()/2||e>this.width()/2||t<-this.height()/2||t>this.height()/2?!1:!0},n.relativePress=function(e,t){return this.hit(e,t)?(null!=this.focus&&this.focus(e,t),this.focused=!0,!0):!1},n.relativeDrag=function(e,t){return 1!=this.focused?!1:(1!=this.hit(e,t)?(null!=this.defocus&&this.defocus(e,t),this.focused=!1):null!=this.focusdrag&&this.focusdrag(e,t),!0)},n.relativeRelease=function(e,t){return 1!=this.focused?!1:(null!=this.click&&this.click(e,t),null!=this.defocus&&this.defocus(e,t),this.focused=!1,!0)},n.pointerReset=function(){null!=this.defocus&&this.defocus(0,0),this.focused=!1},n};var fps={};fps.fpsCounter=0,fps.fpsTimestamp=0,fps.updateFps=function(){if(100==fps.fpsCounter){fps.fpsCounter=0;var e=sys.timestamp(),t=1e5/(e-fps.fpsTimestamp);console.log("FPS : "+t),fps.fpsTimestamp=e}fps.fpsCounter=fps.fpsCounter+1};var error=function(e){window.console&&(window.console.error?window.console.error(e):window.console.log&&window.console.log(e))},loadShader=function(e,t,i,n){var a=n||error,r=e.createShader(i);e.shaderSource(r,t),e.compileShader(r);var o=e.getShaderParameter(r,e.COMPILE_STATUS);return o?r:(lastError=e.getShaderInfoLog(r),a("*** Error compiling shader '"+r+"':"+lastError),e.deleteShader(r),null)},loadProgram=function(e,t,i,n){for(var a={},r=e.createProgram(),o=0;o<t.length;++o)e.attachShader(r,t[o]);e.linkProgram(r);var s=e.getProgramParameter(r,e.LINK_STATUS);if(!s)return lastError=e.getProgramInfoLog(r),error("Error in program linking:"+lastError),e.deleteProgram(r),null;if(i)for(var o=0;o<i.length;++o){var l=i[o]+"_handle";a[l]=e.getAttribLocation(r,i[o])}if(n)for(var o=0;o<n.length;++o){var l=n[o]+"_handle";a[l]=e.getUniformLocation(r,n[o])}return a.program=r,a},createShaderFromScript=function(e,t,i,n){var a,r="",o=document.getElementById(t);if(!o)throw"*** Error: unknown script element"+t;if(r=o.text,!i)if("x-shader/x-vertex"==o.type)a=e.VERTEX_SHADER;else if("x-shader/x-fragment"==o.type)a=e.FRAGMENT_SHADER;else if(a!=e.VERTEX_SHADER&&a!=e.FRAGMENT_SHADER)throw"*** Error: unknown shader type";return loadShader(e,r,i?i:a,n)},createShader=function(e,t,i,n){var a,r=t.text;if(!i)if("x-shader/x-vertex"==t.type)a=e.VERTEX_SHADER;else if("x-shader/x-fragment"==t.type)a=e.FRAGMENT_SHADER;else if(a!=e.VERTEX_SHADER&&a!=e.FRAGMENT_SHADER)throw"*** Error: unknown shader type";return loadShader(e,r,i?i:a,n)},image_program={glProgram:null,getProgram:function(){return null==this.glProgram&&this.loadProgram(),this.glProgram},loadProgram:function(){var e={text:"        attribute vec2 a_position;        attribute vec2 a_tex_coordinate;                uniform mat4 u_projection;        uniform mat4 u_view;        uniform mat4 u_model;                varying vec2 v_tex_coord;                void main() {          gl_Position = u_projection*u_view*u_model*vec4(a_position, 0.0, 1.0);          v_tex_coord = a_tex_coordinate;        }      ",type:"x-shader/x-vertex"},t={text:"        precision mediump float;                varying vec2      v_tex_coord;                uniform sampler2D u_texture;        uniform float     u_alpha;                void main() {          vec4 color = texture2D(u_texture, v_tex_coord);          gl_FragColor = color * u_alpha;        }      ",type:"x-shader/x-fragment"},i=createShader(gl,e),n=createShader(gl,t);this.glProgram=loadProgram(gl,[i,n],["a_position","a_tex_coordinate"],["u_texture","u_alpha","u_model","u_view","u_projection"])}},image={};image.loadImage=function(e){var t=null;if("string"==typeof e)if(console.log("image.new(",e,")",curlify.zipfile),t=curlify.addImageElement(),null!=curlify.zipfile){console.log("image.source zip",i,e,curlify.zipfile);var i=curlify.zipfile.file(e);t.src="data:image/jpg;base64,"+JSZip.base64.encode(i.asBinary())}else console.log("image source file"),t.crossOrigin="anonymous",t.src=e;return t},image["new"]=function(e,t){var i=t?t:quad["new"]("image : "+e);return i.size.width=null,i.size.height=null,e instanceof HTMLElement?(console.log("image.new from canvas",e),i.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,i.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,e),null==i.size.width&&(i.size.width=e.width),null==i.size.height&&(i.size.height=e.height),i.loaded=!0,null!=i.onload&&i.onload()):e instanceof Object?null!=e.texture||null!=e.size?(console.log("image.new from Object",e),i.texture=e.texture,i.image=e.image,null==i.size.width&&(i.size.width=e.size.width),null==i.size.height&&(i.size.height=e.size.height),i.loaded=!0,null!=i.onload&&i.onload()):console.log("ERROR: image.new from unknown Object",e):"string"==typeof e?(console.log("image.new from string",e),i.image=image.loadImage(e),i.image.onload=function(){return null==image?void console.log("image == null!"):(i.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,i.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,i.image),null==i.size.width&&(i.size.width=i.image.width),null==i.size.height&&(i.size.height=i.image.height),console.log("texture loaded : "+i.size.width+"x"+i.size.height),i.loaded=!0,void(null!=i.onload&&i.onload()))},i.image.onerror=function(){console.log("texture load failed",e)}):console.log("ERROR: image.new from unknown object",e),i};var jsonfile={json:null,open:function(e){var t={};if(null!=zip){var i=zip.file(e);null!=i&&(t=JSON.parse(i.asText()))}return this.json=t,this}},masked_image_program={program:null,getProgram:function(){return null==this.glProgram&&this.loadProgram(),this.glProgram},loadProgram:function(){var e={text:"      attribute vec2 a_position;       attribute vec2 a_tex_coordinate;             uniform mat4 u_projection;       uniform mat4 u_view;       uniform mat4 u_model;             varying vec2 v_tex_coord;             void main() {         gl_Position = u_projection*u_view*u_model*vec4(a_position, 0.0, 1.0);         v_tex_coord = a_tex_coordinate;       }       ",type:"x-shader/x-vertex"},t={text:"      precision mediump float;             varying vec2      v_tex_coord;             uniform sampler2D u_texture;       uniform sampler2D u_mask_texture;       uniform float     u_alpha;             void main() {                 vec4 color = texture2D(u_texture, v_tex_coord);         vec4 mask_color = texture2D(u_mask_texture, v_tex_coord);                 gl_FragColor = color * mask_color.a * u_alpha;       }       ",type:"x-shader/x-fragment"},i=createShader(gl,e),n=createShader(gl,t);this.glProgram=loadProgram(gl,[i,n],["a_position","a_tex_coordinate"],["u_texture","u_mask_texture","u_alpha","u_model","u_view","u_projection"])}},masked_image=function(e,t){var i=image["new"](e);return i.identifier="masked_image : "+e+" : "+t,console.log(i.identifier),i.mask=t,i.glProgram=masked_image_program.getProgram(),i.draw=function(){if(1==i.loaded){gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,i.texture),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.activeTexture(gl.TEXTURE1),gl.bindTexture(gl.TEXTURE_2D,i.mask.texture),gl.uniform1i(this.glProgram.u_mask_texture_handle,1),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var e=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,e.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,e.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,e.numItems)}},i};masked_image["new"]=function(e,t){return new masked_image(e,t)};var object={};object["new"]=function(e,t,i){return{identifier:null==e?"object identifier":e,position:{x:0,y:0,z:0},rotate:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},size:{width:null==t?screenWidth:t,height:null==i?screenHeight:i},children:[],active:!0,visible:!0,alpha:1,blend:!0,drawbackside:!1,depthtest:!1,projectionMatrix:curlify.camera.projectionMatrix,viewMatrix:curlify.camera.viewMatrix,modelMatrix:mat4.identity(mat4.create()),modelViewMatrix:mat4.identity(mat4.create()),translateScale:curlify.camera.translateScale,identityMatrix:mat4.identity(mat4.create()),anim:new animator,timervalue:0,lastdraw:0,laststep:0,add:function(e){return e.parent=this,this.children.push(e),e},updateModelMatrix:function(){var e=this.modelMatrix;if(mat4.set(this.identityMatrix,e),0!=this.position.x||0!=this.position.y||0!=this.position.z){var t=screenWidth/(2*this.translateScale);mat4.translate(e,vec3.create([this.position.x/t,-this.position.y/t,this.position.z/t]))}0!=this.rotate.z&&mat4.rotateZ(e,-this.rotate.z),0!=this.rotate.y&&mat4.rotateY(e,-this.rotate.y),0!=this.rotate.x&&mat4.rotateX(e,-this.rotate.x),(1!=this.scale.x||1!=this.scale.y||1!=this.scale.z)&&mat4.scale(e,vec3.create([this.scale.x,this.scale.y,this.scale.z])),this.modelMatrix=e},update:function(){var e=this.viewMatrix;null!=this.parent&&null!=this.parent.modelViewMatrix&&(e=this.parent.modelViewMatrix),this.viewMatrix=e,this.updateModelMatrix(),this.children.length>0&&(mat4.set(this.viewMatrix,this.modelViewMatrix),mat4.multiply(this.modelViewMatrix,this.modelMatrix)),this.depthtest?gl.enable(gl.DEPTH_TEST):gl.disable(gl.DEPTH_TEST),0==this.blend?gl.disable(gl.BLEND):(gl.enable(gl.BLEND),gl.blendFunc(gl.SRC_ALPHA,gl.ONE_MINUS_SRC_ALPHA)),1==this.drawbackside?gl.disable(gl.CULL_FACE):(gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT))},stepTree:function(){var e=Math.max(1,Math.min(sys.timestamp()-this.laststep,60));this.laststep=sys.timestamp(),this.anim.step(),null!=this.preStep&&this.preStep(),null!=this.step&&this.step(e);for(var t=0;t<this.children.length;t++)this.children[t].stepTree();null!=this.postStep&&this.postStep()},drawTree:function(){Math.min(sys.timestamp()-this.lastdraw,60);if(this.lastdraw=sys.timestamp(),0!=this.visible){if(this.update(),null!=this.preDraw&&this.preDraw(),null!=this.draw&&this.draw(),this.reverseDrawOrder)for(var e=this.children.length-1;e>=0;e--)this.children[e].drawTree();else for(var e=0;e<this.children.length;e++)this.children[e].drawTree();null!=this.postDraw&&this.postDraw()}},press:function(e,t){var i=!1;if(null!=this.relativePress){var n=e-screenWidth/2-this.absolutex(),a=t-screenHeight/2-this.absolutey();i=this.relativePress(n,a)}null!=this.absolutePress&&(i=this.absolutePress(e,t));for(var r=this.children.length-1;r>=0;r--)this.children[r].active&&(i=this.children[r].press(e,t));return i},drag:function(e,t){var i=!1;if(null!=this.relativeDrag){var n=e-screenWidth/2-this.absolutex(),a=t-screenHeight/2-this.absolutey();i=this.relativeDrag(n,a)}null!=this.absoluteDrag&&(i=this.absoluteDrag(e,t));for(var r=this.children.length-1;r>=0;r--)this.children[r].active&&(i=this.children[r].drag(e,t));return i},release:function(e,t){var i=!1;if(null!=this.relativeRelease){var n=e-screenWidth/2-this.absolutex(),a=t-screenHeight/2-this.absolutey();i=this.relativeRelease(n,a)}null!=this.absoluteRelease&&(i=this.absoluteRelease(e,t));for(var r=this.children.length-1;r>=0;r--)this.children[r].active&&(i=this.children[r].release(e,t));return i},resetpress:function(){if(1==this.active){for(var e=this.children.length-1;e>=0;e--)this.children[e].resetpress();this!=scene.getpointerStealer()&&null!=this.pointerReset&&this.pointerReset()}},x:function(){return this.position.x},y:function(){return this.position.y},width:function(){return this.size.width*this.scale.x},height:function(){return this.size.height*this.scale.y},top:function(){return this.position.y-this.height()/2},bottom:function(){return this.position.y+this.height()/2},left:function(){return this.position.x-this.width()/2},right:function(){return this.position.x+this.width()/2},absolutex:function(){var e=0;return null!=this.parent&&(e=this.parent.absolutex()),e+this.x()},absolutey:function(){var e=0;return null!=this.parent&&(e=this.parent.absolutey()),e+this.y()},absolutescalex:function(){var e=1;return null!=this.parent&&(e=this.parent.absolutescalex()),e*this.scale.x},absolutescaley:function(){var e=1;return null!=this.parent&&(e=this.parent.absolutescaley()),e*this.scale.y},absolutealpha:function(){var e=1;return null!=this.parent&&(e=this.parent.absolutealpha()),e*this.alpha},activate:function(){this.active=!0,null!=this.postActivate&&this.postActivate()
},deactivate:function(){this.active=!1,null!=this.postDeactivate&&this.postDeactivate()}}};var quad={};quad["new"]=function(e,t,i){null==quad.buffer&&(quad.buffer=gl.createBuffer(),quad.buffer.itemSize=2,quad.buffer.numItems=4,gl.bindBuffer(gl.ARRAY_BUFFER,quad.buffer),vertices=[-1,-1,0,0,1,-1,1,0,-1,1,0,1,1,1,1,1],gl.bufferData(gl.ARRAY_BUFFER,new Float32Array(vertices),gl.STATIC_DRAW));var n=object["new"](e,t,i);return n.glProgram=image_program.getProgram(),n.quadModelMatrix=mat4.identity(mat4.create()),n.updateModelMatrix=function(){var e=this.modelMatrix;if(mat4.set(this.identityMatrix,e),0!=this.position.x||0!=this.position.y||0!=this.position.z){var t=screenWidth/(2*this.translateScale);mat4.translate(e,vec3.create([this.position.x/t,-this.position.y/t,this.position.z/t]))}0!=this.rotate.z&&mat4.rotateZ(e,-this.rotate.z),0!=this.rotate.y&&mat4.rotateY(e,-this.rotate.y),0!=this.rotate.x&&mat4.rotateX(e,-this.rotate.x),(1!=this.scale.x||1!=this.scale.y||1!=this.scale.z)&&mat4.scale(e,vec3.create([this.scale.x,this.scale.y,this.scale.z])),this.modelMatrix=e,mat4.set(this.modelMatrix,this.quadModelMatrix);var i=screenWidth/this.translateScale;mat4.scale(this.quadModelMatrix,vec3.create([this.size.width/i,-this.size.height/i,1]))},n.draw=function(){if(null!=n.texture){gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,n.texture),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var e=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,e.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,e.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,e.numItems)}},n};var rectangle_program={glProgram:null,getProgram:function(){return null==this.glProgram&&this.loadProgram(),this.glProgram},loadProgram:function(){var e={text:"        attribute vec2 a_position;                uniform mat4 u_projection;        uniform mat4 u_view;        uniform mat4 u_model;                void main() {          gl_Position = u_projection*u_view*u_model*vec4(a_position, 0.0, 1.0);        }",type:"x-shader/x-vertex"},t={text:"        precision mediump float;                uniform float     u_red;        uniform float     u_green;        uniform float     u_blue;        uniform float     u_alpha;                void main() {          gl_FragColor = vec4( u_red, u_green, u_blue, 1.0 ) * u_alpha;        }",type:"x-shader/x-fragment"},i=createShader(gl,e),n=createShader(gl,t);this.glProgram=loadProgram(gl,[i,n],["a_position"],["u_red","u_green","u_blue","u_alpha","u_model","u_view","u_projection"])}},rectangle=function(e,t,i){var n=quad["new"]("rectangle",e,t);return n.glProgram=rectangle_program.getProgram(),n.color=null==i?{red:0,green:0,blue:0}:i,n.draw=function(){gl.useProgram(this.glProgram.program),gl.uniform1f(this.glProgram.u_red_handle,this.color.red),gl.uniform1f(this.glProgram.u_green_handle,this.color.green),gl.uniform1f(this.glProgram.u_blue_handle,this.color.blue),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var e=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,e.itemSize,gl.FLOAT,!1,16,0),gl.drawArrays(gl.TRIANGLE_STRIP,0,e.numItems)},n};rectangle["new"]=function(e,t,i){return new rectangle(e,t,i)};var scene=function(){var e=[],t=[],i=animator["new"](),n=null;return{render:function(){if(i.step(),i.animations.length>0){var n=e[e.length-2];n.stepTree(),n.drawTree()}var a=e[e.length-1];if(null!=a){a.stepTree(),a.drawTree();for(var r=0;r<t.length;r++)!new function(){var e=t[r];e.renderFbo()};t=[]}},openScene:function(t,n,a){var r=e[e.length-1];e.push(t),null!=n&&i.animate(t,n),null!=r&&null!=a&&i.animate(r,a)},closeScene:function(t,n){var a=e[e.length-1],r=e[e.length-2];if(null!=t){var o=t.onComplete,s=function(){null!=o&&o(),e.splice(e.length-1,1),console.log("remove scene from stack",a.identifier,e.length)};t.onComplete=s,i.animate(a,t)}else e.splice(e.length-1,1);null!=r&&null!=n&&i.animate(r,n)},removeAllScenes:function(){e=[],t=[],i.stop(),n=null},isAnimating:function(){return i.animations.length>0?!0:!1},getPointerUser:function(){return n?n:e[e.length-1]},getpointerStealer:function(){return n},stealPointers:function(t){console.log("stealPointers",t);var i=n?n:e[e.length-1];n=t,i.resetpress()},resetPointerStealer:function(){n=null},addFboUpdate:function(e){t.push(e)}}}(),scrollable={};scrollable["new"]=function(e,t,i){var n=focusable["new"](e,t,i);n.contentsize={width:n.size.width,height:n.size.height},n.movespeed=1,n.movethreshold=40,n.swipespeed=(screenWidth+screenHeight)/2*5,n.maxspeed=200,n.inertia=7,n.zeroposition=0,n.loaddistance=screenHeight,n.visibledistance=n.loaddistance,n.itempad=0,n.centerslots=!1,n.swipefunc=animator.inQuad;var a=n.add(object["new"]("scrollable"));n.instance=a,a.targetposition={x:0,y:0,z:0};var r=function(e,t,i){i>100&&(i=100);var a=1;e>t&&(a=-1);var r=-a*(i/(16.66*n.inertia))*Math.abs(e-t),o=i/16.66*n.maxspeed;return r>o&&(r=o),-o>r&&(r=-o),Math.abs(r)<1e-5?e=t:e-=r,1==a&&e>t&&(e=t),-1==a&&t>e&&(e=t),e};n.focus=function(e,t){a.pressOffset={x:a.position.x-e*n.movespeed,y:a.position.y-t*n.movespeed},a.moving&&(a.resetpress(),a.moving=!1)},n.defocus=function(){scene.getpointerStealer()==n&&n.centeronslots(),console.log("DEFOCUS",n.identifier,a.position.y,a.targetposition.y)},n.centeronslots=function(){if(n.centerslots){var e=Math.floor(n.selected()/(screenWidth+n.itempad));n.movetox(e*(screenWidth+n.itempad)+screenWidth/2)}},a.setMoving=function(){0==a.moving&&null==scene.getpointerStealer()&&(scene.stealPointers(n),a.moving=!0)},n.focusdrag=function(e,t){var i=a.pressOffset.x+e*n.movespeed,r=a.pressOffset.y+t*n.movespeed,o=i-a.targetposition.x,s=r-a.targetposition.y;n.contentsize.width!=n.size.width&&Math.abs(o)>n.movethreshold&&a.setMoving(),n.contentsize.height!=n.size.height&&Math.abs(s)>n.movethreshold&&a.setMoving(),a.moving&&(a.targetposition.x=i,a.targetposition.y=r)},n.step=function(e){var t=-(n.contentsize.width-n.size.width)+n.zeroposition,i=-(n.contentsize.height-n.size.height),o=e;o>66&&(o=66),0!=n.enforcelimits&&(a.targetposition.x>n.size.width/4+n.zeroposition&&(a.targetposition.x=n.size.width/4+n.zeroposition),a.targetposition.y>n.size.height/4&&(a.targetposition.y=n.size.height/4),a.targetposition.x<t-n.size.width/4&&(a.targetposition.x=t-n.size.width/4),a.targetposition.y<i-n.size.height/4&&(a.targetposition.y=i-n.size.height/4),0==n.focused&&(a.targetposition.x>n.zeroposition&&(a.targetposition.x=r(a.targetposition.x,n.zeroposition,e/2)),a.targetposition.y>0&&(a.targetposition.y=r(a.targetposition.y,0,e/2)),a.targetposition.x<t&&(a.targetposition.x=r(a.targetposition.x,t,e/2)),a.targetposition.y<i&&(a.targetposition.y=r(a.targetposition.y,i,e/2)))),0==n.focused&&(o/=2),n.contentsize.width!=n.size.width&&(a.position.x=r(a.position.x,a.targetposition.x,o)),n.contentsize.height!=n.size.height&&(a.position.y=r(a.position.y,a.targetposition.y,o)),0==n.focused&&a.position.x==a.targetposition.x&&a.position.y==a.targetposition.y&&(a.moving=!1)},n.selected=function(){return Math.floor(a.targetposition.x)},n.movetox=function(e,t){t&&(a.position.x=e),a.targetposition.x=e},n.movetoy=function(e,t){t&&(a.position.y=e),a.targetposition.y=e},n.prepare=function(){n.step(0);for(var e=0;e<a.children.length;e++)a.children[e].step(0)};var o=4*screenWidth,s=4*screenHeight,l=-o,c=o,u=-s,h=s;return n.intersectsScreen=function(e){var t=e.absolutex(),i=e.absolutey(),n=t-e.width()/2,a=t+e.width()/2,r=i-e.height()/2,o=i+e.height()/2;return!(l>a||n>c||u>o||r>h)},n.add=function(e,t){t?t:a.children.length;return e.parent=a,a.children.push(e),e.step=function(){this.xdistance=this.absolutex();var e=Math.sqrt(Math.pow(this.xdistance,2)+Math.pow(this.absolutey(),2));if(e<n.loaddistance)null!=this.load_content&&0==this.loaded&&this.load_content();else{var t=n.unloaddistance;null==t&&(t=n.loaddistance),e>t&&null!=this.load_content&&null!=this.unload_content&&this.loaded&&this.unload_content()}this.visible=e<n.visibledistance?!0:!1,this.distance=e},e},n};var sprite={};sprite.newSheet=function(e,t,i){var n={spritewidth:0,spriteheight:0,frames:[]};if(e instanceof Array){var a=t,r=i,o=document.createElement("canvas");o.width=a,o.height=r;var s=o.getContext("2d");console.log("sprite.newSheet.onload",typeof o,o);for(var l=0,c=0;c<e.length;c++)!new function(){var t=image.loadImage(e[c]);t.onload=function(){s.drawImage(t,0,0),n.frames.push(image["new"](o)),s.clearRect(0,0,o.width,o.height),l+=1,l==e.length&&null!=n.onload&&n.onload()}};console.log("sprite.newSheet",e,e.length,t,i,n.frames.length),n.spritewidth=a,n.spriteheight=r,n.name="array "+e.length}else{var u=image.loadImage(e);u.onload=function(){var a=u.width/t,r=u.height/i,o=document.createElement("canvas");o.width=a,o.height=r;var s=o.getContext("2d");console.log("sprite.newSheet.onload",typeof o,o);for(var l=0;i>l;l++)for(var c=0;t>c;c++)s.drawImage(u,-c*a,-l*r),n.frames.push(image["new"](o)),s.clearRect(0,0,o.width,o.height);console.log("sprite.newSheet",e,u.width,u.height,t,i,n.frames.length),n.spritewidth=a,n.spriteheight=r,n.name=e,null!=n.onload&&n.onload()}}return n},sprite.newFromSheet=function(e,t,i,n,a){i=i?i:e.frames.length,n=n?n:0;for(var r=a?a:focusable["new"]("spritesheet "+e.name),o=n;n+i>o;o++){var s=r.add(image["new"](e.frames[o]));s.visible=!1,s.active=!1}return r.size.width=e.spritewidth,r.size.height=e.spriteheight,r.frame=r.children[0],r.frametimervalue=0,r.frametime=35,console.log("newFromSheet",e.name,n,i,r.children.length),r.restart=function(e){r.frametimervalue=0;var i=r.restart;0==t&&(i=null);var n=r.loopdelay&&!e?r.loopdelay:0;r.anim.animate(r,{frametimervalue:r.children.length,start:n,time:r.frametime*r.children.length,onComplete:i})},r.preStep=function(){r.frame.visible=!1;var e=Math.floor(r.frametimervalue);e>r.children.length-1||(r.frame=r.children[e],r.frame.visible=!0)},r.start=function(){return r.anim.animations.length>0&&r.anim.animations[0].paused?void r.anim.resume():void r.restart()},r.stop=function(){r.anim.pause()},r.unload=function(){r.anim.stop()},0!=t&&r.restart(!0),r},sprite["new"]=function(e,t,i,n,a,r){var o=sprite.newSheet(e,t,i),s=object["new"]("sprite loader");return s.sheet=o,o.onload=function(){sprite.newFromSheet(o,n,a,r,s),null!=s.onload&&s.onload()},s},sys={},sys.timestamp=function(){return(new Date).getTime()},sys.ismobile={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return sys.ismobile.Android()||sys.ismobile.BlackBerry()||sys.ismobile.iOS()||sys.ismobile.Opera()||sys.ismobile.Windows()}};var text=function(e,t,i,n,a,r){var a=a?a:screenWidth,o=quad["new"]("text : "+e+" : "+a+","+r);console.log("NEW TEXT: "+o.identifier),o.glProgram=image_program.getProgram(),o.canvas=document.createElement("canvas"),o.canvas.width=a,o.canvas.height=2*t,o.context=o.canvas.getContext("2d"),o.context.fillStyle="rgba("+255*n.red+","+255*n.green+","+255*n.blue+",255)",o.context.textAlign="center",o.context.textBaseline="middle",o.context.font=t+"px "+i;var s,l,c=[],u=t,h=a;createMultilineText(o.context,e,a,c);var g=h,d=u*(c.length+1);s=g/2;for(var m=.5*(d-u*(c.length+1)),p=0;p<c.length;p++)l=(p+1)*u+m,o.context.fillText(c[p],s,l),console.log(c[p],s,l);return o.size.width=o.canvas.width,o.size.height=o.canvas.height,o.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,o.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,o.canvas),o.draw=function(){gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,o.texture),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var e=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,e.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,e.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,e.numItems)},o};text["new"]=function(e,t,i,n,a,r){return new text(e,t,i,n,a,r)};var video=function(e){function t(){console.log("startVideo"),s.player.play()}function i(){console.log("videoDone")}function n(){console.log("progress")}function a(){console.log("playing")}function r(){console.log("stalling")}function o(){console.log("suspend")}var s=focusable["new"]("video : "+e);s.glProgram=image_program.getProgram(),s.player=document.createElement("video");var l=!1;if(s.player.autoplay=!0,s.player.loop=!0,s.player.oncanplay=function(){l=!0},s.player.onerror=function(){var e="unknown error";switch(s.player.error.code){case 1:e="video loading aborted";break;case 2:e="network loading error";break;case 3:e="video decoding failed / corrupted data or unsupported codec";break;case 4:e="video not supported"}console.log("Error: "+e+" (errorcode="+s.player.error.code+")")},null!=zip&&"http"!=e.slice(0,4)){var c=zip.file(e);console.log("video.source zip",c,e,zip),s.player.type="video/mp4",s.player.src="data:video/mp4;base64,"+JSZip.base64.encode(c.asBinary())}else console.log("video.source ",e),s.player.src=e,s.player.crossOrigin="anonymous";return sys.ismobile.any()&&(s.click=function(e,t){console.log("video click",e,t),s.player.play()},s.focus=function(e,t){console.log("video focus",e,t)}),s.preload="auto",s.player.addEventListener("canplaythrough",t,!0),s.player.addEventListener("ended",i,!0),s.player.addEventListener("progress",n,!0),s.player.addEventListener("playing",a,!0),s.player.addEventListener("stalling",r,!0),s.player.addEventListener("suspend",o,!0),s.player.setAttribute("playsinline",""),s.player.setAttribute("webkit-playsinline",""),s.player.load(),s.player.play(),s.texture=gl.createTexture(),gl.bindTexture(gl.TEXTURE_2D,s.texture),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,1,1,0,gl.RGBA,gl.UNSIGNED_BYTE,new Uint8Array([0,0,0,0])),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),s.draw=function(){if(1!=s.loaded)return void(l&&(console.log("video texture loaded : "+s.size.width+"x"+s.size.height),null!=s.onload&&s.onload(),s.loaded=!0));gl.useProgram(this.glProgram.program),gl.activeTexture(gl.TEXTURE0),gl.bindTexture(gl.TEXTURE_2D,s.texture),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR),gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR),gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,s.player),gl.uniform1i(this.glProgram.u_texture_handle,0),gl.uniform1f(this.glProgram.u_alpha_handle,this.absolutealpha()),gl.uniformMatrix4fv(this.glProgram.u_projection_handle,!1,this.projectionMatrix),gl.uniformMatrix4fv(this.glProgram.u_view_handle,!1,this.viewMatrix),gl.uniformMatrix4fv(this.glProgram.u_model_handle,!1,this.quadModelMatrix);var e=this.buffer?this.buffer:quad.buffer;gl.bindBuffer(gl.ARRAY_BUFFER,e),gl.enableVertexAttribArray(this.glProgram.a_position_handle),gl.enableVertexAttribArray(this.glProgram.a_tex_coordinate_handle),gl.vertexAttribPointer(this.glProgram.a_position_handle,e.itemSize,gl.FLOAT,!1,16,0),gl.vertexAttribPointer(this.glProgram.a_tex_coordinate_handle,e.itemSize,gl.FLOAT,!1,16,8),gl.drawArrays(gl.TRIANGLE_STRIP,0,e.numItems)},s.checkstatus=function(){console.log("video status : "+s.player.paused+" : "+s.player.buffered+" : "+s.player.error),console.log("readyState  :"+s.player.readyState),console.log("startDate  :"+s.player.startDate),console.log("duration  :"+s.player.duration),console.log("currentSrc  :"+s.player.currentSrc),s.anim.animate(s,{alpha:1,time:2e3,onComplete:s.checkstatus})},s};video["new"]=function(e){return new video(e)};var viewWidth=null,viewHeight=null,screenWidth=null,screenHeight=null,curlify=function(){function initWebGL(e){gl=null;try{gl=e.getContext("webgl")||e.getContext("experimental-webgl")}catch(t){}return gl||(alert("Unable to initialize WebGL. Your browser may not support it."),gl=null),gl}function mousedown(e){if(!scene.isAnimating()&&1!=touch){console.log("mousedown : "+e.clientX+","+e.clientY,instance.layoutOffset.x,instance.layoutOffset.y),touch=!0;var t=scene.getPointerUser();null!=t&&(t.press((e.clientX-instance.layoutOffset.x)*instance.layoutScale.x,(e.clientY-instance.layoutOffset.y)*instance.layoutScale.y),t.drag((e.clientX-instance.layoutOffset.x)*instance.layoutScale.x,(e.clientY-instance.layoutOffset.y)*instance.layoutScale.y))}}function mouseup(e){if(scene.resetPointerStealer(),!scene.isAnimating()&&0!=touch){console.log("mouseup : "+e.clientX+","+e.clientY),touch=!1;var t=scene.getPointerUser();null!=t&&t.release((e.clientX-instance.layoutOffset.x)*instance.layoutScale.x,(e.clientY-instance.layoutOffset.y)*instance.layoutScale.y)}}function mouseout(e){touch&&mouseup(e)}function mousemove(e){if(!scene.isAnimating()&&0!=touch){var t=scene.getPointerUser();null!=t&&touch&&t.drag((e.clientX-instance.layoutOffset.x)*instance.layoutScale.x,(e.clientY-instance.layoutOffset.y)*instance.layoutScale.y)}}function touchstart(e){if(!scene.isAnimating()&&1!=touch){touch=!0;var t=scene.getPointerUser();null!=t&&(t.press((e.touches[0].pageX-instance.layoutOffset.x)*instance.layoutScale.x,(e.touches[0].pageY-instance.layoutOffset.y)*instance.layoutScale.y),t.drag((e.touches[0].pageX-instance.layoutOffset.x)*instance.layoutScale.x,(e.touches[0].pageY-instance.layoutOffset.y)*instance.layoutScale.y),lasttouch=e)}}function touchend(){if(scene.resetPointerStealer(),!scene.isAnimating()&&0!=touch){touch=!1;var e=scene.getPointerUser();null!=e&&e.release(lasttouch.touches[0].pageX-instance.layoutOffset.x,lasttouch.touches[0].pageY-instance.layoutOffset.y)}}function touchmove(e){if(e.preventDefault(),!scene.isAnimating()&&0!=touch){var t=scene.getPointerUser();null!=t&&(touch&&t.drag((e.touches[0].pageX-instance.layoutOffset.x)*instance.layoutScale.x,(e.touches[0].pageY-instance.layoutOffset.y)*instance.layoutScale.y),lasttouch=e)}}function deviceMotionHandler(e){instance.sensors.acceleration=e.acceleration,instance.sensors.rotation=e.rotationRate}function deviceOrientationHandler(e){instance.sensors.orientation=e}function orientationChanged(){console.log("ORIENTATION CHANGED")}function resizeCanvas(){var e=glcanvas.clientWidth,t=glcanvas.clientHeight;if(glcanvas.width!=e||glcanvas.height!=t){instance.layoutWidth=e,instance.layoutHeight=t,instance.layoutScale={x:screenWidth/instance.layoutWidth,y:screenHeight/instance.layoutHeight},viewWidth=screenWidth,viewHeight=screenHeight;var i=Math.max(instance.layoutScale.x,instance.layoutScale.y);aspectratioZoom&&(i=Math.min(instance.layoutScale.x,instance.layoutScale.y),viewWidth=e*i,viewHeight=t*i),instance.layoutScale.x=i,instance.layoutScale.y=i,instance.layoutWidth=Math.floor(screenWidth*(1/i)),instance.layoutHeight=Math.floor(screenHeight*(1/i)),instance.layoutOffset.x=(e-instance.layoutWidth)/2,instance.layoutOffset.y=(t-instance.layoutHeight)/2,glcanvas.width=glcanvas.clientWidth,glcanvas.height=glcanvas.clientHeight,console.log("resized",glcanvas.width,glcanvas.height,viewWidth,viewHeight)}console.log("resizeCanvas",glcanvas.clientWidth,glcanvas.clientHeight,screenWidth,screenHeight,glcanvas.width,glcanvas.height)}function MergeRecursive(e,t){for(var i in t)try{e[i]=t[i].constructor==Object?MergeRecursive(e[i],t[i]):t[i]}catch(n){e[i]=t[i]}return e}var glcanvas,aspectratioZoom=!0,touch=!1,lasttouch=null,imageid=0,running=!1,appendedElements=[],requires={},instance={};instance.sensors={acceleration:null,rotation:null,orientation:null},instance.zipfile=null,instance.layoutWidth=null,instance.layoutHeight=null,instance.layoutOffset={x:0,y:0},instance.layoutScale={x:1,y:1},instance.camera=null;var createProjection=function(e,t,i,n){var a=mat4.create();return a[0]=i/e,a[5]=i/t,a[10]=-(n+i)/(n-i),a[11]=-1,a[14]=-2*n*i/(n-i),a},createProjectionAndView=function(e,t,i,n){var a=createProjection(1,t/e,i,n),r=mat4.identity(mat4.create());mat4.translate(r,vec3.create([0,0,-(n-i)/2]));var o=(n-i)/2/i,s={near:i,far:n,width:e,height:t,projectionMatrix:a,viewMatrix:r,translateScale:o};return s};return instance.assert=function(e,t){if(!e)throw t||"Assertion failed"},instance.require=function(script,callback){console.log("require(",script,")");var scriptid=script,element=document.getElementById(scriptid);if(null==element)if(console.log("create element",script,scriptid),element=document.createElement("script"),element.setAttribute("id",scriptid),element.setAttribute("type","script-container"),document.head.appendChild(element),appendedElements.push(scriptid),".zip"==script.slice(-4))JSZipUtils.getBinaryContent(script,function(err,data){if(err)return console.log("ERROR: unable to load script zip",script,err),void(null!=callback&&callback(null));instance.zipfile=new JSZip(data);var adscriptfile=instance.zipfile.file("main.js");return null==adscriptfile?(console.log("ERROR: no main.js found in zip"),instance.zipfile=null,void(null!=callback&&callback(null))):(element.scriptobject=eval(adscriptfile.asText()),void(null!=callback&&callback(element.scriptobject)))});else if(".js"==script.slice(-3)){var request=instance.createCORSRequest("GET",script);request.onload=function(){console.log("script loaded",script),element.scriptobject=eval(request.responseText),null!=callback&&callback(element.scriptobject)},request.onerror=function(){console.log("ERROR: script load failed",script),null!=callback&&callback(null)},request.send()}else console.log("ERROR: unsupported script source",script),null!=callback&&callback(null);else null!=callback&&callback(element.scriptobject)},instance.addImageElement=function(){var e="curlify_image_"+imageid,t=document.createElement("img");return t.setAttribute("id",e),document.body.appendChild(t),appendedElements.push(e),imageid+=1,t},instance.createCORSRequest=function(e,t){var i=new XMLHttpRequest;return"withCredentials"in i?i.open(e,t,!0):"undefined"!=typeof XDomainRequest?(i=new XDomainRequest,i.open(e,t)):i=null,i},instance.getRandom=function(e,t){return Math.floor(Math.random()*(t-e)+e)},instance.render=function(){gl.clearColor(0,0,0,0),gl.clear(gl.COLOR_BUFFER_BIT|gl.DEPTH_BUFFER_BIT),gl.disable(gl.DEPTH_TEST),gl.enable(gl.CULL_FACE),gl.cullFace(gl.FRONT),gl.viewport(instance.layoutOffset.x,instance.layoutOffset.y,instance.layoutWidth,instance.layoutHeight),scene.render()},instance.setRenderInterval=function(e){null!=instance.intervalId&&window.clearInterval(instance.intervalId),instance.intervalId=window.setInterval(instance.render,e)},instance.stop=function(){if(console.log("Cleaning up..."),null==glcanvas)return void console.log("ERROR: canvas not set");"ontouchstart"in window?(glcanvas.removeEventListener("touchstart",touchstart,!1),glcanvas.removeEventListener("touchmove",touchmove,!1),glcanvas.removeEventListener("touchend",touchend,!1)):(glcanvas.removeEventListener("mousedown",mousedown,!1),glcanvas.removeEventListener("mousemove",mousemove,!1),glcanvas.removeEventListener("mouseup",mouseup,!1)),window.DeviceMotionEvent&&window.removeEventListener("devicemotion",deviceMotionHandler,!1),window.DeviceOrientationEvent&&window.removeEventListener("deviceorientation",deviceOrientationHandler,!1),window.removeEventListener("orientationchange",orientationChanged),scene.removeAllScenes();for(var e=0;e<appendedElements.length;e++){var t=appendedElements[e],i=document.getElementById(t);i.parentNode.removeChild(i),console.log("... removed element "+t)}appendedElements=[],null!=instance.intervalId&&(console.log("... stopping render interval"),window.clearInterval(instance.intervalId)),requires={},running=!1},instance.start=function(e){running&&instance.stop(),running=!0,instance.assert(null!=e.canvas),instance.assert(null!=e.script);var t=e.canvas,i=e.script,n=e.width,a=e.height;screenWidth=n?n:480,screenHeight=a?a:852;var r=document.getElementById(t);null!=glcanvas?r!=glcanvas&&(console.log("canvas changed - initialize new webgl"),glcanvas=r,gl=initWebGL(glcanvas)):(glcanvas=r,gl=initWebGL(glcanvas)),"ontouchstart"in window?(console.log("USE TOUCH MOUSE"),glcanvas.addEventListener("touchstart",touchstart,!1),glcanvas.addEventListener("touchmove",touchmove,!1),glcanvas.addEventListener("touchend",touchend,!1)):(console.log("USE REGULAR MOUSE"),glcanvas.addEventListener("mousedown",mousedown,!1),glcanvas.addEventListener("mousemove",mousemove,!1),glcanvas.addEventListener("mouseup",mouseup,!1)),resizeCanvas(),instance.camera=createProjectionAndView(screenWidth,screenHeight,3,100),gl&&(window.DeviceMotionEvent?window.addEventListener("devicemotion",deviceMotionHandler,!1):alert("DeviceMotionEvent not supported"),window.DeviceOrientationEvent?window.addEventListener("deviceorientation",deviceOrientationHandler,!1):alert("DeviceOrientationEvent not supported"),window.addEventListener("orientationchange",orientationChanged),instance.require(i,function(t){scene.openScene(t["new"]()),null!=e.renderInterval&&instance.setRenderInterval(e.renderInterval)}))},instance}();